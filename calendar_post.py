#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
暦情報自動投稿システム - 完全版（全セクション実装）
見本と同等の情報量を提供
"""

import os
import json
import sys
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo
import math
import requests
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow
from google.auth.transport.requests import Request
from googleapiclient.discovery import build

SCOPES = ['https://www.googleapis.com/auth/blogger']

class SolarTermCalculator:
    """二十四節気・七十二候の天文計算クラス（毎年自動対応）"""
    
    @staticmethod
    def calculate_solar_term_date(year, solar_longitude):
        """
        指定した年と太陽黄経から節気の日付を計算
        太陽黄経: 0°=春分, 15°=清明, 30°=穀雨, ..., 345°=啓蟄
        略算式を使用（精度±1日）
        """
        # 二十四節気の係数（DとA）
        # 出典: 海上保安庁水路部の略算式を拡張
        sekki_params = {
            315: (5.01, 0.242778),   # 立春
            330: (19.70, 0.242713),  # 雨水
            345: (6.38, 0.242627),   # 啓蟄
            0:   (21.43, 0.242194),  # 春分
            15:  (5.59, 0.241934),   # 清明
            30:  (21.04, 0.241669),  # 穀雨
            45:  (6.30, 0.241424),   # 立夏
            60:  (22.18, 0.241176),  # 小満
            75:  (6.62, 0.240959),   # 芒種
            90:  (22.29, 0.240715),  # 夏至
            105: (7.93, 0.240460),   # 小暑
            120: (23.95, 0.240252),  # 大暑
            135: (8.52, 0.240014),   # 立秋
            150: (24.30, 0.239766),  # 処暑
            165: (8.60, 0.239527),   # 白露
            180: (23.89, 0.239300),  # 秋分
            195: (9.09, 0.239063),   # 寒露
            210: (24.19, 0.238825),  # 霜降
            225: (8.19, 0.238591),   # 立冬
            240: (23.15, 0.238355),  # 小雪
            255: (7.93, 0.238120),   # 大雪
            270: (22.66, 0.237885),  # 冬至
            285: (6.12, 0.237651),   # 小寒
            300: (20.87, 0.237418)   # 大寒
        }
        
        if solar_longitude not in sekki_params:
            return None
        
        D, A = sekki_params[solar_longitude]
        
        # 1月・2月の節気は前年基準で計算
        if solar_longitude in [285, 300, 315, 330]:
            Y = year - 1900 - 1
        else:
            Y = year - 1900
        
        # 略算式: INT(D + (A × Y) - INT(Y / 4))
        day = int(D + (A * Y) - int(Y / 4))
        
        # 月の決定
        if solar_longitude == 285:  # 小寒
            month = 1
        elif solar_longitude == 300:  # 大寒
            month = 1
            day += 15
        elif solar_longitude == 315:  # 立春
            month = 2
        elif solar_longitude == 330:  # 雨水
            month = 2
            day += 14
        elif solar_longitude == 345:  # 啓蟄
            month = 3
        elif solar_longitude == 0:  # 春分
            month = 3
            day += 15
        elif solar_longitude == 15:  # 清明
            month = 4
        elif solar_longitude == 30:  # 穀雨
            month = 4
            day += 15
        elif solar_longitude == 45:  # 立夏
            month = 5
        elif solar_longitude == 60:  # 小満
            month = 5
            day += 16
        elif solar_longitude == 75:  # 芒種
            month = 6
        elif solar_longitude == 90:  # 夏至
            month = 6
            day += 16
        elif solar_longitude == 105:  # 小暑
            month = 7
        elif solar_longitude == 120:  # 大暑
            month = 7
            day += 16
        elif solar_longitude == 135:  # 立秋
            month = 8
        elif solar_longitude == 150:  # 処暑
            month = 8
            day += 16
        elif solar_longitude == 165:  # 白露
            month = 9
        elif solar_longitude == 180:  # 秋分
            month = 9
            day += 16
        elif solar_longitude == 195:  # 寒露
            month = 10
        elif solar_longitude == 210:  # 霜降
            month = 10
            day += 15
        elif solar_longitude == 225:  # 立冬
            month = 11
        elif solar_longitude == 240:  # 小雪
            month = 11
            day += 15
        elif solar_longitude == 255:  # 大雪
            month = 12
        elif solar_longitude == 270:  # 冬至
            month = 12
            day += 15
        
        return (month, day)
    
    @classmethod
    def get_current_sekki(cls, date):
        """現在の二十四節気を天文計算で取得"""
        year = date.year
        month = date.month
        day = date.day
        
        # 全24節気の定義
        sekki_definitions = [
            (315, "立春", "りっしゅん", "春の始まり。暦の上では春ですが、まだ寒さが厳しい時期です。"),
            (330, "雨水", "うすい", "雪が雨に変わり、氷が解け始める頃。三寒四温で春に向かいます。"),
            (345, "啓蟄", "けいちつ", "冬眠していた虫が目覚める頃。春の訪れを実感できます。"),
            (0, "春分", "しゅんぶん", "昼夜の長さがほぼ等しくなる日。これから昼が長くなります。"),
            (15, "清明", "せいめい", "万物が清らかで生き生きとする頃。花が咲き誇る季節です。"),
            (30, "穀雨", "こくう", "穀物を潤す春の雨が降る頃。田植えの準備が始まります。"),
            (45, "立夏", "りっか", "夏の始まり。新緑が目に鮮やかな季節です。"),
            (60, "小満", "しょうまん", "草木が茂り、天地に気が満ち始める頃です。"),
            (75, "芒種", "ぼうしゅ", "麦を刈り、稲を植える農繁期。梅雨入りの時期です。"),
            (90, "夏至", "げし", "一年で最も昼が長い日。これから暑さが本格化します。"),
            (105, "小暑", "しょうしょ", "梅雨明け頃。本格的な暑さの始まりです。"),
            (120, "大暑", "たいしょ", "一年で最も暑い時期。夏真っ盛りです。"),
            (135, "立秋", "りっしゅう", "秋の始まり。暦の上では秋ですが、残暑が厳しい時期。"),
            (150, "処暑", "しょしょ", "暑さが峠を越える頃。朝夕が涼しくなり始めます。"),
            (165, "白露", "はくろ", "草木に白い露が宿り始める頃。秋の気配が濃くなります。"),
            (180, "秋分", "しゅうぶん", "昼夜の長さがほぼ等しい。秋彼岸の中日です。"),
            (195, "寒露", "かんろ", "露が冷たく感じられる頃。紅葉が始まります。"),
            (210, "霜降", "そうこう", "朝霜が降り始める頃。秋が深まります。"),
            (225, "立冬", "りっとう", "冬の始まり。暦の上では冬入りです。"),
            (240, "小雪", "しょうせつ", "わずかに雪が降り始める頃。冬の気配が強まります。"),
            (255, "大雪", "たいせつ", "雪が本格的に降り始める頃。山は雪化粧です。"),
            (270, "冬至", "とうじ", "一年で最も昼が短い日。これから日が長くなります。"),
            (285, "小寒", "しょうかん", "寒さが厳しくなり始める頃。寒の入りです。"),
            (300, "大寒", "だいかん", "一年で最も寒い時期。寒さの極みです。")
        ]
        
        # 各節気の日付を計算
        sekki_dates = []
        for longitude, name, reading, desc in sekki_definitions:
            term_date = cls.calculate_solar_term_date(year, longitude)
            if term_date:
                sekki_dates.append((term_date[0], term_date[1], name, reading, desc))
        
        # 前年の冬の節気も追加（年始の判定用）
        for longitude in [255, 270, 285, 300]:
            term_date = cls.calculate_solar_term_date(year - 1, longitude)
            if term_date:
                for lng, name, reading, desc in sekki_definitions:
                    if lng == longitude:
                        sekki_dates.append((term_date[0], term_date[1], name, reading, desc))
        
        # 現在の日付に最も近い過去の節気を探す
        current_sekki = sekki_dates[0][2:]
        for m, d, name, reading, desc in sekki_dates:
            if month > m or (month == m and day >= d):
                current_sekki = (name, reading, desc)
        
        return current_sekki
    
    @classmethod
    def get_kou_info(cls, date):
        """現在の七十二候"""
        month = date.month
        day = date.day
        
        kou_list = [
            (1, 5, "芹乃栄", "せりすなわちさかう", "芹が盛んに生え始める頃。小寒です。"),
            (1, 10, "水泉動", "しみずあたたかをふくむ", "地中で凍った泉が動き始める頃です。"),
            (1, 15, "雉始雊", "きじはじめてなく", "雉が鳴き始める頃です。"),
            (1, 20, "款冬華", "ふきのはなさく", "蕗の花が咲く頃。大寒です。"),
            (1, 25, "水沢腹堅", "さわみずこおりつめる", "沢の水が厚く凍る頃。寒さの極みです。"),
            (1, 30, "鶏始乳", "にわとりはじめてとやにつく", "鶏が卵を産み始める頃です。"),
            (2, 4, "東風解凍", "はるかぜこおりをとく", "春風が氷を解かし始める頃。立春の初候です。"),
            (2, 9, "黄鶯睍睆", "うぐいすなく", "鶯が山里で鳴き始める頃。春の訪れを告げる鳴き声です。"),
            (2, 14, "魚上氷", "うおこおりをいずる", "割れた氷の間から魚が飛び跳ねる頃です。"),
            (2, 19, "土脉潤起", "つちのしょううるおいおこる", "雨が降って土が湿り気を含む頃です。"),
            (2, 24, "霞始靆", "かすみはじめてたなびく", "霞がたなびき、春景色が広がる頃です。"),
            (3, 1, "草木萌動", "そうもくめばえいずる", "草木が芽吹き始める頃。春の息吹を感じます。"),
            (3, 5, "蟄虫啓戸", "すごもりむしとをひらく", "冬眠していた虫が外に這い出てくる頃です。"),
            (3, 10, "桃始笑", "ももはじめてさく", "桃の花が咲き始める頃。笑は咲くの意味です。"),
            (3, 15, "菜虫化蝶", "なむしちょうとなる", "青虫が蝶に羽化する頃。春の生命の躍動です。"),
            (3, 20, "雀始巣", "すずめはじめてすくう", "雀が巣を作り始める頃です。"),
            (3, 25, "櫻始開", "さくらはじめてひらく", "桜が咲き始める頃。春の代名詞です。"),
            (3, 30, "雷乃発声", "かみなりすなわちこえをはっす", "遠くで雷の音が聞こえ始める頃です。"),
            (4, 4, "玄鳥至", "つばめきたる", "燕が南から渡ってくる頃。春の使者です。"),
            (4, 9, "鴻雁北", "こうがんかえる", "雁が北へ帰っていく頃です。"),
            (4, 14, "虹始見", "にじはじめてあらわる", "雨上がりに虹が出始める頃です。"),
            (4, 20, "葭始生", "あしはじめてしょうず", "葦が芽を吹き始める頃です。"),
            (4, 25, "霜止出苗", "しもやんでなえいず", "霜が降りなくなり、苗が育つ頃です。"),
            (4, 30, "牡丹華", "ぼたんはなさく", "牡丹の花が咲く頃。華やかな春の終わりです。"),
            (5, 5, "蛙始鳴", "かわずはじめてなく", "蛙が鳴き始める頃。初夏の風物詩です。"),
            (5, 10, "蚯蚓出", "みみずいずる", "蚯蚓が地上に這い出てくる頃です。"),
            (5, 15, "竹笋生", "たけのこしょうず", "筍が生えてくる頃。旬の味覚です。"),
            (5, 21, "蚕起食桑", "かいこおきてくわをはむ", "蚕が桑の葉を盛んに食べ始める頃です。"),
            (5, 26, "紅花栄", "べにばなさかう", "紅花が盛んに咲く頃です。"),
            (5, 31, "麦秋至", "むぎのときいたる", "麦が熟し、収穫期を迎える頃です。"),
            (6, 5, "蟷螂生", "かまきりしょうず", "蟷螂が生まれ出る頃です。"),
            (6, 10, "腐草為螢", "くされたるくさほたるとなる", "蛍が光を放ち始める頃。初夏の風情です。"),
            (6, 16, "梅子黄", "うめのみきばむ", "梅の実が黄ばんで熟す頃です。"),
            (6, 21, "乃東枯", "なつかれくさかるる", "夏枯草が枯れる頃。夏至の日です。"),
            (6, 26, "菖蒲華", "あやめはなさく", "菖蒲の花が咲く頃です。"),
            (7, 2, "半夏生", "はんげしょうず", "烏柄杓が生える頃。田植えの目安とされました。"),
            (7, 7, "温風至", "あつかぜいたる", "暑い風が吹いてくる頃。夏本番です。"),
            (7, 12, "蓮始開", "はすはじめてひらく", "蓮の花が開き始める頃です。"),
            (7, 17, "鷹乃学習", "たかすなわちわざをならう", "鷹の幼鳥が飛び方を覚える頃です。"),
            (7, 22, "桐始結花", "きりはじめてはなをむすぶ", "桐の花が実を結ぶ頃です。"),
            (7, 28, "土潤溽暑", "つちうるおうてむしあつし", "土が湿って蒸し暑くなる頃です。"),
            (8, 2, "大雨時行", "たいうときどきふる", "時として大雨が降る頃。夕立の季節です。"),
            (8, 7, "涼風至", "すずかぜいたる", "涼しい風が吹き始める頃。立秋です。"),
            (8, 12, "寒蝉鳴", "ひぐらしなく", "蜩が鳴き始める頃。秋の気配を感じます。"),
            (8, 17, "蒙霧升降", "ふかききりまとう", "深い霧がまとわりつく頃です。"),
            (8, 23, "綿柎開", "わたのはなしべひらく", "綿の花のがくが開く頃です。"),
            (8, 28, "天地始粛", "てんちはじめてさむし", "天地の暑さが収まり始める頃です。"),
            (9, 2, "禾乃登", "こくものすなわちみのる", "稲が実る頃。実りの秋です。"),
            (9, 7, "草露白", "くさのつゆしろし", "草に降りた露が白く見える頃です。"),
            (9, 12, "鶺鴒鳴", "せきれいなく", "鶺鴒が鳴き始める頃です。"),
            (9, 17, "玄鳥去", "つばめさる", "燕が南へ帰っていく頃です。"),
            (9, 23, "雷乃収声", "かみなりすなわちこえをおさむ", "雷が鳴らなくなる頃。秋分です。"),
            (9, 28, "蟄虫坏戸", "むしかくれてとをふさぐ", "虫が土の中に隠れる頃です。"),
            (10, 3, "水始涸", "みずはじめてかるる", "田んぼの水を抜き始める頃です。"),
            (10, 8, "鴻雁来", "こうがんきたる", "雁が飛来する頃。冬鳥の到来です。"),
            (10, 13, "菊花開", "きくのはなひらく", "菊の花が咲く頃です。"),
            (10, 18, "蟋蟀在戸", "きりぎりすとにあり", "蟋蟀が戸口で鳴く頃です。"),
            (10, 23, "霜始降", "しもはじめてふる", "霜が降り始める頃。霜降です。"),
            (10, 28, "霎時施", "こさめときどきふる", "小雨がしとしと降る頃です。"),
            (11, 2, "楓蔦黄", "もみじつたきばむ", "紅葉や蔦が黄葉する頃です。"),
            (11, 7, "山茶始開", "つばきはじめてひらく", "山茶花が咲き始める頃。立冬です。"),
            (11, 12, "地始凍", "ちはじめてこおる", "大地が凍り始める頃です。"),
            (11, 17, "金盞香", "きんせんかさく", "水仙の花が咲く頃です。"),
            (11, 22, "虹蔵不見", "にじかくれてみえず", "虹を見かけなくなる頃。小雪です。"),
            (11, 27, "朔風払葉", "きたかぜこのはをはらう", "北風が木の葉を払い落とす頃。冬の風物詩です。"),
            (12, 2, "橘始黄", "たちばなはじめてきばむ", "橘の実が黄色く色づく頃です。"),
            (12, 7, "閉塞成冬", "そらさむくふゆとなる", "天地の気が塞がり、本格的な冬となる頃。大雪です。"),
            (12, 12, "熊蟄穴", "くまあなにこもる", "熊が冬眠のために穴に入る頃です。"),
            (12, 16, "鱖魚群", "さけのうおむらがる", "鮭が群がって川を上る頃です。"),
            (12, 21, "乃東生", "なつかれくさしょうず", "夏枯草が芽を出す頃。冬至です。"),
            (12, 26, "麋角解", "さわしかつのおつる", "大鹿が角を落とす頃です。"),
            (12, 31, "雪下出麦", "ゆきわたりてむぎのびる", "雪の下で麦が芽を出す頃です。")
        ]
        
        current_kou = kou_list[0][2:]
        
        for m, d, name, reading, desc in reversed(kou_list):
            if month > m or (month == m and day >= d):
                current_kou = (name, reading, desc)
                break
        
        if month == 12 and day >= 31:
            current_kou = ("雪下出麦", "ゆきわたりてむぎのびる", "雪の下で麦が芽を出す頃です。")
        elif month == 1 and day < 5:
            current_kou = ("雪下出麦", "ゆきわたりてむぎのびる", "雪の下で麦が芽を出す頃です。")
        
        return current_kou
            (2, 14, "魚上氷", "うおこおりをいずる", "割れた氷の間から魚が飛び跳ねる頃です。"),
            (2, 19, "土脉潤起", "つちのしょううるおいおこる", "雨が降って土が湿り気を含む頃です。"),
            (2, 24, "霞始靆", "かすみはじめてたなびく", "霞がたなびき、春景色が広がる頃です。"),
            (2, 29, "草木萌動", "そうもくめばえいずる", "草木が芽吹き始める頃。春の息吹を感じます。"),
            (3, 5, "蟄虫啓戸", "すごもりむしとをひらく", "冬眠していた虫が外に這い出てくる頃です。"),
            (3, 10, "桃始笑", "ももはじめてさく", "桃の花が咲き始める頃。笑は咲くの意味です。"),
            (3, 15, "菜虫化蝶", "なむしちょうとなる", "青虫が蝶に羽化する頃。春の生命の躍動です。"),
            (3, 20, "雀始巣", "すずめはじめてすくう", "雀が巣を作り始める頃です。"),
            (3, 25, "櫻始開", "さくらはじめてひらく", "桜が咲き始める頃。春の代名詞です。"),
            (3, 30, "雷乃発声", "かみなりすなわちこえをはっす", "遠くで雷の音が聞こえ始める頃です。"),
            (4, 4, "玄鳥至", "つばめきたる", "燕が南から渡ってくる頃。春の使者です。"),
            (4, 9, "鴻雁北", "こうがんかえる", "雁が北へ帰っていく頃です。"),
            (4, 14, "虹始見", "にじはじめてあらわる", "雨上がりに虹が出始める頃です。"),
            (4, 20, "葭始生", "あしはじめてしょうず", "葦が芽を吹き始める頃です。"),
            (4, 25, "霜止出苗", "しもやんでなえいず", "霜が降りなくなり、苗が育つ頃です。"),
            (4, 30, "牡丹華", "ぼたんはなさく", "牡丹の花が咲く頃。華やかな春の終わりです。"),
            # 夏
            (5, 5, "蛙始鳴", "かわずはじめてなく", "蛙が鳴き始める頃。初夏の風物詩です。"),
            (5, 10, "蚯蚓出", "みみずいずる", "蚯蚓が地上に這い出てくる頃です。"),
            (5, 15, "竹笋生", "たけのこしょうず", "筍が生えてくる頃。旬の味覚です。"),
            (5, 21, "蚕起食桑", "かいこおきてくわをはむ", "蚕が桑の葉を盛んに食べ始める頃です。"),
            (5, 26, "紅花栄", "べにばなさかう", "紅花が盛んに咲く頃です。"),
            (5, 31, "麦秋至", "むぎのときいたる", "麦が熟し、収穫期を迎える頃です。"),
            (6, 5, "蟷螂生", "かまきりしょうず", "蟷螂が生まれ出る頃です。"),
            (6, 10, "腐草為螢", "くされたるくさほたるとなる", "蛍が光を放ち始める頃。初夏の風情です。"),
            (6, 16, "梅子黄", "うめのみきばむ", "梅の実が黄ばんで熟す頃です。"),
            (6, 21, "乃東枯", "なつかれくさかるる", "夏枯草が枯れる頃。夏至の日です。"),
            (6, 26, "菖蒲華", "あやめはなさく", "菖蒲の花が咲く頃です。"),
            (7, 2, "半夏生", "はんげしょうず", "烏柄杓が生える頃。田植えの目安とされました。"),
            (7, 7, "温風至", "あつかぜいたる", "暑い風が吹いてくる頃。夏本番です。"),
            (7, 12, "蓮始開", "はすはじめてひらく", "蓮の花が開き始める頃です。"),
            (7, 17, "鷹乃学習", "たかすなわちわざをならう", "鷹の幼鳥が飛び方を覚える頃です。"),
            (7, 22, "桐始結花", "きりはじめてはなをむすぶ", "桐の花が実を結ぶ頃です。"),
            (7, 28, "土潤溽暑", "つちうるおうてむしあつし", "土が湿って蒸し暑くなる頃です。"),
            (8, 2, "大雨時行", "たいうときどきふる", "時として大雨が降る頃。夕立の季節です。"),
            # 秋
            (8, 7, "涼風至", "すずかぜいたる", "涼しい風が吹き始める頃。立秋です。"),
            (8, 12, "寒蝉鳴", "ひぐらしなく", "蜩が鳴き始める頃。秋の気配を感じます。"),
            (8, 17, "蒙霧升降", "ふかききりまとう", "深い霧がまとわりつく頃です。"),
            (8, 23, "綿柎開", "わたのはなしべひらく", "綿の花のがくが開く頃です。"),
            (8, 28, "天地始粛", "てんちはじめてさむし", "天地の暑さが収まり始める頃です。"),
            (9, 2, "禾乃登", "こくものすなわちみのる", "稲が実る頃。実りの秋です。"),
            (9, 7, "草露白", "くさのつゆしろし", "草に降りた露が白く見える頃です。"),
            (9, 12, "鶺鴒鳴", "せきれいなく", "鶺鴒が鳴き始める頃です。"),
            (9, 17, "玄鳥去", "つばめさる", "燕が南へ帰っていく頃です。"),
            (9, 23, "雷乃収声", "かみなりすなわちこえをおさむ", "雷が鳴らなくなる頃。秋分です。"),
            (9, 28, "蟄虫坏戸", "むしかくれてとをふさぐ", "虫が土の中に隠れる頃です。"),
            (10, 3, "水始涸", "みずはじめてかるる", "田んぼの水を抜き始める頃です。"),
            (10, 8, "鴻雁来", "こうがんきたる", "雁が飛来する頃。冬鳥の到来です。"),
            (10, 13, "菊花開", "きくのはなひらく", "菊の花が咲く頃です。"),
            (10, 18, "蟋蟀在戸", "きりぎりすとにあり", "蟋蟀が戸口で鳴く頃です。"),
            (10, 23, "霜始降", "しもはじめてふる", "霜が降り始める頃。霜降です。"),
            (10, 28, "霎時施", "こさめときどきふる", "小雨がしとしと降る頃です。"),
            (11, 2, "楓蔦黄", "もみじつたきばむ", "紅葉や蔦が黄葉する頃です。"),
            # 冬
            (11, 7, "山茶始開", "つばきはじめてひらく", "山茶花が咲き始める頃。立冬です。"),
            (11, 12, "地始凍", "ちはじめてこおる", "大地が凍り始める頃です。"),
            (11, 17, "金盞香", "きんせんかさく", "水仙の花が咲く頃です。"),
            (11, 22, "虹蔵不見", "にじかくれてみえず", "虹を見かけなくなる頃。小雪です。"),
            (11, 27, "朔風払葉", "きたかぜこのはをはらう", "北風が木の葉を払い落とす頃。冬の風物詩です。"),
            (12, 2, "橘始黄", "たちばなはじめてきばむ", "橘の実が黄色く色づく頃です。"),
            (12, 7, "閉塞成冬", "そらさむくふゆとなる", "天地の気が塞がり、本格的な冬となる頃。大雪です。"),
            (12, 12, "熊蟄穴", "くまあなにこもる", "熊が冬眠のために穴に入る頃です。"),
            (12, 16, "鱖魚群", "さけのうおむらがる", "鮭が群がって川を上る頃です。"),
            (12, 21, "乃東生", "なつかれくさしょうず", "夏枯草が芽を出す頃。冬至です。"),
            (12, 26, "麋角解", "さわしかつのおつる", "大鹿が角を落とす頃です。"),
            (12, 31, "雪下出麦", "ゆきわたりてむぎのびる", "雪の下で麦が芽を出す頃です。"),
            (1, 5, "芹乃栄", "せりすなわちさかう", "芹が盛んに生え始める頃。小寒です。"),
            (1, 10, "水泉動", "しみずあたたかをふくむ", "地中で凍った泉が動き始める頃です。"),
            (1, 15, "雉始雊", "きじはじめてなく", "雉が鳴き始める頃です。"),
            (1, 20, "款冬華", "ふきのはなさく", "蕗の花が咲く頃。大寒です。"),
            (1, 25, "水沢腹堅", "さわみずこおりつめる", "沢の水が厚く凍る頃。寒さの極みです。"),
            (1, 30, "鶏始乳", "にわとりはじめてとやにつく", "鶏が卵を産み始める頃です。")
        ]
        
        # 現在の候を探す（最も近い日付の候を選択）
        current_kou = kou_complete_list[0][2:]  # デフォルト
        
        for m, d, name, reading, desc in reversed(kou_complete_list):
            if month > m or (month == m and day >= d):
                current_kou = (name, reading, desc)
                break
        
        # 年末年始の処理（12月後半〜1月初旬）
        if month == 12 and day >= 31:
            current_kou = ("雪下出麦", "ゆきわたりてむぎのびる", "雪の下で麦が芽を出す頃です。")
        elif month == 1 and day < 5:
            current_kou = ("雪下出麦", "ゆきわたりてむぎのびる", "雪の下で麦が芽を出す頃です。")
        
        return current_kou
            (2, 9, "黄鶯睍睆", "うぐいすなく", "鶯が山里で鳴き始める頃。春の訪れを告げる鳴き声です。"),
            (2, 14, "魚上氷", "うおこおりをいずる", "割れた氷の間から魚が飛び跳ねる頃です。"),
            (2, 19, "土脉潤起", "つちのしょううるおいおこる", "雨が降って土が湿り気を含む頃です。"),
            (2, 24, "霞始靆", "かすみはじめてたなびく", "霞がたなびき、春景色が広がる頃です。"),
            (2, 29, "草木萌動", "そうもくめばえいずる", "草木が芽吹き始める頃。春の息吹を感じます。"),
            (3, 5, "蟄虫啓戸", "すごもりむしとをひらく", "冬眠していた虫が外に這い出てくる頃です。"),
            (3, 10, "桃始笑", "ももはじめてさく", "桃の花が咲き始める頃。笑は咲くの意味です。"),
            (3, 15, "菜虫化蝶", "なむしちょうとなる", "青虫が蝶に羽化する頃。春の生命の躍動です。"),
            (3, 20, "雀始巣", "すずめはじめてすくう", "雀が巣を作り始める頃です。"),
            (3, 25, "櫻始開", "さくらはじめてひらく", "桜が咲き始める頃。春の代名詞です。"),
            (3, 30, "雷乃発声", "かみなりすなわちこえをはっす", "遠くで雷の音が聞こえ始める頃です。"),
            (4, 4, "玄鳥至", "つばめきたる", "燕が南から渡ってくる頃。春の使者です。"),
            (4, 9, "鴻雁北", "こうがんかえる", "雁が北へ帰っていく頃です。"),
            (4, 14, "虹始見", "にじはじめてあらわる", "雨上がりに虹が出始める頃です。"),
            (4, 20, "葭始生", "あしはじめてしょうず", "葦が芽を吹き始める頃です。"),
            (4, 25, "霜止出苗", "しもやんでなえいず", "霜が降りなくなり、苗が育つ頃です。"),
            (4, 30, "牡丹華", "ぼたんはなさく", "牡丹の花が咲く頃。華やかな春の終わりです。"),
            # 夏
            (5, 5, "蛙始鳴", "かわずはじめてなく", "蛙が鳴き始める頃。初夏の風物詩です。"),
            (5, 10, "蚯蚓出", "みみずいずる", "蚯蚓が地上に這い出てくる頃です。"),
            (5, 15, "竹笋生", "たけのこしょうず", "筍が生えてくる頃。旬の味覚です。"),
            (5, 21, "蚕起食桑", "かいこおきてくわをはむ", "蚕が桑の葉を盛んに食べ始める頃です。"),
            (5, 26, "紅花栄", "べにばなさかう", "紅花が盛んに咲く頃です。"),
            (5, 31, "麦秋至", "むぎのときいたる", "麦が熟し、収穫期を迎える頃です。"),
            (6, 5, "蟷螂生", "かまきりしょうず", "蟷螂が生まれ出る頃です。"),
            (6, 10, "腐草為螢", "くされたるくさほたるとなる", "蛍が光を放ち始める頃。初夏の風情です。"),
            (6, 16, "梅子黄", "うめのみきばむ", "梅の実が黄ばんで熟す頃です。"),
            (6, 21, "乃東枯", "なつかれくさかるる", "夏枯草が枯れる頃。夏至の日です。"),
            (6, 26, "菖蒲華", "あやめはなさく", "菖蒲の花が咲く頃です。"),
            (7, 2, "半夏生", "はんげしょうず", "烏柄杓が生える頃。田植えの目安とされました。"),
            (7, 7, "温風至", "あつかぜいたる", "暑い風が吹いてくる頃。夏本番です。"),
            (7, 12, "蓮始開", "はすはじめてひらく", "蓮の花が開き始める頃です。"),
            (7, 17, "鷹乃学習", "たかすなわちわざをならう", "鷹の幼鳥が飛び方を覚える頃です。"),
            (7, 22, "桐始結花", "きりはじめてはなをむすぶ", "桐の花が実を結ぶ頃です。"),
            (7, 28, "土潤溽暑", "つちうるおうてむしあつし", "土が湿って蒸し暑くなる頃です。"),
            (8, 2, "大雨時行", "たいうときどきふる", "時として大雨が降る頃。夕立の季節です。"),
            # 秋
            (8, 7, "涼風至", "すずかぜいたる", "涼しい風が吹き始める頃。立秋です。"),
            (8, 12, "寒蝉鳴", "ひぐらしなく", "蜩が鳴き始める頃。秋の気配を感じます。"),
            (8, 17, "蒙霧升降", "ふかききりまとう", "深い霧がまとわりつく頃です。"),
            (8, 23, "綿柎開", "わたのはなしべひらく", "綿の花のがくが開く頃です。"),
            (8, 28, "天地始粛", "てんちはじめてさむし", "天地の暑さが収まり始める頃です。"),
            (9, 2, "禾乃登", "こくものすなわちみのる", "稲が実る頃。実りの秋です。"),
            (9, 7, "草露白", "くさのつゆしろし", "草に降りた露が白く見える頃です。"),
            (9, 12, "鶺鴒鳴", "せきれいなく", "鶺鴒が鳴き始める頃です。"),
            (9, 17, "玄鳥去", "つばめさる", "燕が南へ帰っていく頃です。"),
            (9, 23, "雷乃収声", "かみなりすなわちこえをおさむ", "雷が鳴らなくなる頃。秋分です。"),
            (9, 28, "蟄虫坏戸", "むしかくれてとをふさぐ", "虫が土の中に隠れる頃です。"),
            (10, 3, "水始涸", "みずはじめてかるる", "田んぼの水を抜き始める頃です。"),
            (10, 8, "鴻雁来", "こうがんきたる", "雁が飛来する頃。冬鳥の到来です。"),
            (10, 13, "菊花開", "きくのはなひらく", "菊の花が咲く頃です。"),
            (10, 18, "蟋蟀在戸", "きりぎりすとにあり", "蟋蟀が戸口で鳴く頃です。"),
            (10, 23, "霜始降", "しもはじめてふる", "霜が降り始める頃。霜降です。"),
            (10, 28, "霎時施", "こさめときどきふる", "小雨がしとしと降る頃です。"),
            (11, 2, "楓蔦黄", "もみじつたきばむ", "紅葉や蔦が黄葉する頃です。"),
            # 冬
            (11, 7, "山茶始開", "つばきはじめてひらく", "山茶花が咲き始める頃。立冬です。"),
            (11, 12, "地始凍", "ちはじめてこおる", "大地が凍り始める頃です。"),
            (11, 17, "金盞香", "きんせんかさく", "水仙の花が咲く頃です。"),
            (11, 22, "虹蔵不見", "にじかくれてみえず", "虹を見かけなくなる頃。小雪です。"),
            (11, 27, "朔風払葉", "きたかぜこのはをはらう", "北風が木の葉を払い落とす頃。冬の風物詩です。"),
            (12, 2, "橘始黄", "たちばなはじめてきばむ", "橘の実が黄色く色づく頃です。"),
            (12, 7, "閉塞成冬", "そらさむくふゆとなる", "天地の気が塞がり、本格的な冬となる頃。大雪です。"),
            (12, 12, "熊蟄穴", "くまあなにこもる", "熊が冬眠のために穴に入る頃です。"),
            (12, 16, "鱖魚群", "さけのうおむらがる", "鮭が群がって川を上る頃です。"),
            (12, 21, "乃東生", "なつかれくさしょうず", "夏枯草が芽を出す頃。冬至です。"),
            (12, 26, "麋角解", "さわしかつのおつる", "大鹿が角を落とす頃です。"),
            (12, 31, "雪下出麦", "ゆきわたりてむぎのびる", "雪の下で麦が芽を出す頃です。"),
            (1, 5, "芹乃栄", "せりすなわちさかう", "芹が盛んに生え始める頃。小寒です。"),
            (1, 10, "水泉動", "しみずあたたかをふくむ", "地中で凍った泉が動き始める頃です。"),
            (1, 15, "雉始雊", "きじはじめてなく", "雉が鳴き始める頃です。"),
            (1, 20, "款冬華", "ふきのはなさく", "蕗の花が咲く頃。大寒です。"),
            (1, 25, "水沢腹堅", "さわみずこおりつめる", "沢の水が厚く凍る頃。寒さの極みです。"),
            (1, 30, "鶏始乳", "にわとりはじめてとやにつく", "鶏が卵を産み始める頃です。")
        ]
        
        # 現在の候を探す（最も近い日付の候を選択）
        current_kou = kou_complete_list[0][2:]  # デフォルト
        
        for m, d, name, reading, desc in reversed(kou_complete_list):
            if month > m or (month == m and day >= d):
                current_kou = (name, reading, desc)
                break
        
        # 年末年始の処理（12月後半〜1月初旬）
        if month == 12 and day >= 31:
            current_kou = ("雪下出麦", "ゆきわたりてむぎのびる", "雪の下で麦が芽を出す頃です。")
        elif month == 1 and day < 5:
            current_kou = ("雪下出麦", "ゆきわたりてむぎのびる", "雪の下で麦が芽を出す頃です。")
        
        return current_kou


class AccurateLunarCalendar:
    """正確な旧暦計算"""
    
    @staticmethod
    def calculate_lunar_date(date):
        """旧暦を計算（修正版 - 2025年12月10日=旧暦10/21, 月齢19.8を基準）"""
        # 2025年12月10日 = 旧暦2025年10月21日、月齢19.8を基準点とする
        reference = datetime(2025, 12, 10, 12, 0, tzinfo=ZoneInfo("Asia/Tokyo"))
        reference_lunar_year = 2025
        reference_lunar_month = 10
        reference_lunar_day = 21
        reference_moon_age = 19.8
        
        synodic = 29.530588861  # 朔望月周期
        
        # 経過日数を計算
        elapsed_days = (date - reference).total_seconds() / 86400
        
        # 月齢を計算
        moon_age = (reference_moon_age + elapsed_days) % synodic
        if moon_age < 0:
            moon_age += synodic
        
        # 経過した朔望月数
        elapsed_months = int((reference_moon_age + elapsed_days) / synodic)
        
        # 旧暦の年月日を計算
        total_months_from_ref = elapsed_months
        lunar_year = reference_lunar_year
        lunar_month = reference_lunar_month
        lunar_day = reference_lunar_day
        
        # 月の進行
        for _ in range(abs(total_months_from_ref)):
            if total_months_from_ref > 0:
                lunar_month += 1
                if lunar_month > 12:
                    lunar_month = 1
                    lunar_year += 1
            else:
                lunar_month -= 1
                if lunar_month < 1:
                    lunar_month = 12
                    lunar_year -= 1
        
        # 日の計算
        days_in_current_month = elapsed_days - (elapsed_months * synodic)
        lunar_day = reference_lunar_day + int(days_in_current_month)
        
        # 日の繰り上がり・繰り下がり処理
        while lunar_day > 30:
            lunar_day -= 30
            lunar_month += 1
            if lunar_month > 12:
                lunar_month = 1
                lunar_year += 1
        
        while lunar_day < 1:
            lunar_day += 30
            lunar_month -= 1
            if lunar_month < 1:
                lunar_month = 12
                lunar_year -= 1
        
        if lunar_day > 30:
            lunar_day = 30
        
        # 月相の判定（月齢に基づく）
        if moon_age < 1.5:
            phase = "新月"
            appearance = "夜空に月は見えません"
        elif moon_age < 3.7:
            phase = "二日月"
            appearance = "夕方の西空に細い月が輝きます"
        elif moon_age < 7.4:
            phase = "上弦へ向かう月"
            appearance = "夕方の空に弓なりの上弦へ向かう月"
        elif 7.4 <= moon_age < 11:
            phase = "上弦の月"
            appearance = "宵の空に半月が見えます"
        elif moon_age < 14.8:
            phase = "満月へ向かう月"
            appearance = "宵から夜半にかけて膨らむ月"
        elif 14.8 <= moon_age < 16.3:
            phase = "満月"
            appearance = "夜通し輝く丸い月"
        elif moon_age < 22.1:
            phase = "下弦へ向かう月"
            appearance = "夜半から明け方に欠けていく月"
        elif 22.1 <= moon_age < 25.9:
            phase = "下弦の月"
            appearance = "明け方に半月が見えます"
        else:
            phase = "晦日月"
            appearance = "明け方の東空に細い月"
        
        return {
            'year': lunar_year,
            'month': lunar_month,
            'day': lunar_day,
            'age': round(moon_age, 1),
            'phase': phase,
            'appearance': appearance
        }


class ComprehensiveCalendarGenerator:
    """包括的な暦情報生成"""
    
    def __init__(self, target_date=None):
        self.jst = ZoneInfo("Asia/Tokyo")
        self.date = target_date or datetime.now(self.jst)
        self.month = self.date.month
        self.day = self.date.day
        self.gemini = GeminiContentEnhancer()  # Gemini強化版を使用
    
    def get_lunar_month_names(self):
        """旧暦月の異名と説明"""
        names = {
            1: ("睦月", "むつき", "親族が睦み合う月"),
            2: ("如月", "きさらぎ", "衣を更に着る寒い月"),
            3: ("弥生", "やよい", "草木がいよいよ生い茂る月"),
            4: ("卯月", "うづき", "卯の花が咲く月"),
            5: ("皐月", "さつき", "早苗を植える月"),
            6: ("水無月", "みなづき", "水の月、または田に水を引く月"),
            7: ("文月", "ふみづき", "文を披露する月、七夕の月"),
            8: ("葉月", "はづき", "葉が落ち始める月"),
            9: ("長月", "ながつき", "夜が長くなる月"),
            10: ("神無月", "かんなづき", "神々が出雲に集まる月。出雲では神在月"),
            11: ("霜月", "しもつき", "霜が降り始める月"),
            12: ("師走", "しわす", "師も走るほど忙しい月")
        }
        return names
    
    def generate_seasonal_description(self, lunar, sekki, kou):
        """季節の詳細な説明（Gemini強化版）"""
        # Gemini APIで生成を試みる
        gemini_text = self.gemini.enhance_seasonal_description(self.date, lunar, sekki, kou)
        if gemini_text:
            return gemini_text
        
        # フォールバック
        lunar_names = self.get_lunar_month_names()
        lunar_info = lunar_names.get(lunar['month'], ("", "", ""))
        
        descriptions = {
            12: f"旧暦{lunar['month']}月は「{lunar_info[0]}」。{lunar['phase']}の頃は、{lunar['appearance']}が見られる季節です。このころは古くから「一年の終わりを告げる月」とされ、年越しの準備に忙しい時期。空気が澄み渡り、冬の星座が美しく輝きます。",
            1: f"旧暦{lunar['month']}月は「{lunar_info[0]}」。{lunar['phase']}の頃は、{lunar['appearance']}が見られる季節です。新しい年の始まりで、寒さが最も厳しい時期ですが、春への期待が膨らみます。",
            11: f"旧暦{lunar['month']}月は「{lunar_info[0]}」または地域によっては「神在月」。出雲へ全国の神々が集う月とされ、{lunar['phase']}の頃は{lunar['appearance']}が見られます。このころは古くから「冬の到来を告げる月」とされ、夜が長く火の明かりが恋しくなる季節。虫の音も静まり、空気が澄み渡るため、星がたいへん美しく見えます。"
        }
        
        return descriptions.get(self.month, descriptions[12])
    
    def get_nature_changes(self):
        """自然の変化（12ヶ月完全版）"""
        changes_by_month = {
            1: ["寒さが最も厳しくなる", "池や水たまりに氷が張る", "早朝の霜柱が美しい", "ロウバイや梅のつぼみが膨らみ始める"],
            2: ["梅の花が咲き始める", "鶯の初音が聞こえる", "日差しが少しずつ強くなる", "雪解けが始まる地域も"],
            3: ["桜の開花が始まる", "菜の花が一面に咲く", "蝶が飛び始める", "春の嵐が吹くことも"],
            4: ["新緑が美しくなる", "ツバメが飛来する", "筍が顔を出す", "八重桜が咲く"],
            5: ["新緑が濃くなる", "田植えが始まる", "初鰹が旬を迎える", "初夏の風が心地よい"],
            6: ["梅雨入りする", "紫陽花が咲く", "蛍が飛び交う", "夏至で昼が最も長くなる"],
            7: ["梅雨明けする", "セミが鳴き始める", "入道雲が湧く", "海水浴シーズン到来"],
            8: ["残暑が厳しい", "台風の季節", "早朝に秋の気配を感じる", "ペルセウス座流星群が見られる"],
            9: ["秋の七草が咲く", "稲刈りが始まる", "赤とんぼが飛ぶ", "秋分の日を境に夜が長くなる"],
            10: ["紅葉が始まる", "金木犀の香りが漂う", "秋雨前線が停滞", "渡り鳥が南へ向かう"],
            11: ["紅葉が見頃を迎える", "木枯らしが吹く", "冬鳥が飛来する", "初雪の便りが届く"],
            12: ["霜柱が早朝に見られる", "カモなど冬鳥が増える", "干し柿づくりが盛ん", "冬木立となる"]
        }
        return changes_by_month.get(self.month, changes_by_month[12])
    
    def get_agricultural_calendar(self):
        """農事歴"""
        calendars = {
            12: {
                'title': '冬支度の農期',
                'activities': [
                    '稲作地域では脱穀がほぼ終盤',
                    '畑では大根・白菜・ネギなど冬野菜が甘みを増す頃',
                    '東北や北海道では畑に堆肥をまき、土を休ませる準備',
                    '伝統的には「漬物の仕込み」の季節で、沢庵漬け、白菜漬けなどが家々に並び始めます'
                ],
                'detail': '昔の農村では、この時期は農作業が一段落し、冬に向けて機具の手入れや縄綯い（なわない）などの室内作業が中心でした。'
            },
            1: {
                'title': '農閑期',
                'activities': [
                    '農具の手入れと修理',
                    '藁細工や縄綯いなどの室内作業',
                    '堆肥づくりの準備',
                    '春の作付け計画を立てる'
                ],
                'detail': '寒さが厳しく屋外作業は少ないですが、春に向けての大切な準備期間です。'
            }
        }
        return calendars.get(self.month, calendars[12])
    
    def get_customs_and_traditions(self):
        """風習・しきたり（12ヶ月完全版）"""
        customs = {
            1: {'description': '1月は新年を迎え、初詣、鏡開き、小正月など、一年の始まりにふさわしい伝統行事が目白押しです。', 'items': ['初詣', '七草粥（1月7日）', '鏡開き（1月11日）', '小正月（1月15日）', '寒中見舞い']},
            2: {'description': '2月は節分で豆まきを行い、立春を迎えます。寒さの中にも春の気配を感じる月です。', 'items': ['節分・豆まき（2月3日頃）', '初午（はつうま）', 'バレンタインデー', '建国記念の日（2月11日）', '針供養（2月8日）']},
            3: {'description': '3月はひな祭りで女の子の成長を祝い、春分の日には彼岸の墓参りを行います。', 'items': ['ひな祭り（3月3日）', '啓蟄', '春分の日・彼岸', '卒業式', 'ホワイトデー']},
            4: {'description': '4月は入学・入社の季節で、桜の開花とともに新しい生活が始まります。', 'items': ['入学式・入社式', '花見', '灌仏会（花まつり・4月8日）', '昭和の日（4月29日）', '田植えの準備']},
            5: {'description': '5月はゴールデンウィークがあり、端午の節句で男の子の成長を祝います。', 'items': ['端午の節句（5月5日）', 'こどもの日', '母の日', '八十八夜', '田植え']},
            6: {'description': '6月は梅雨入りの時期で、夏至を迎えます。夏越の祓で半年の穢れを払います。', 'items': ['衣替え（6月1日）', '入梅', '夏越の祓（6月30日）', '父の日', '梅仕事']},
            7: {'description': '7月は七夕まつり、お盆の準備が始まります。各地で夏祭りが開催されます。', 'items': ['七夕（7月7日）', '土用の丑の日', 'お盆（7月または8月）', '海開き・山開き', '夏祭り']},
            8: {'description': '8月はお盆で先祖を迎え、送り火を焚きます。終戦記念日もあります。', 'items': ['お盆（8月13〜16日）', '迎え火・送り火', '終戦記念日（8月15日）', '夏祭り・花火大会', '地蔵盆']},
            9: {'description': '9月は重陽の節句、秋分の日には彼岸の墓参りを行います。収穫の季節です。', 'items': ['重陽の節句（9月9日）', '十五夜（中秋の名月）', '秋分の日・彼岸', '敬老の日', '秋祭り']},
            10: {'description': '10月は神無月として知られ、出雲では神在祭が行われます。秋の収穫祭の季節です。', 'items': ['衣替え（10月1日）', '十三夜', '体育の日', 'ハロウィン', '秋祭り・収穫祭']},
            11: {'description': '11月下旬は新嘗祭の余韻が残る頃で、冬囲いなどの冬支度が始まります。', 'items': ['文化の日（11月3日）', '七五三（11月15日）', '新嘗祭（11月23日）', '勤労感謝の日', '冬囲い']},
            12: {'description': '12月は一年の締めくくりの月で、冬囲い、すす払い、正月飾りの準備などが行われます。', 'items': ['冬囲い（雪国の家や庭木を守る作業）', 'すす払い（12月13日頃）', '正月飾りの準備', '冬至の柚子湯（12月21日頃）', 'クリスマスの準備']}
        }
        return customs.get(self.month, customs[12])
    
    def get_holidays_and_events(self):
        """記念日と祝日"""
        events_db = {
            (12, 7): [
                ('大雪', '二十四節気の一つ'),
            ],
            (12, 21): [
                ('冬至', '一年で最も昼が短い日'),
            ],
            (12, 25): [
                ('クリスマス', 'キリスト教の祭日として世界的に祝われる'),
            ],
            (12, 31): [
                ('大晦日', '一年の最後の日。除夜の鐘が鳴り響く'),
            ],
            (1, 1): [
                ('元日', '国民の祝日。一年の始まり'),
                ('初日の出', '新年最初の日の出を拝む習慣'),
            ],
            (1, 7): [
                ('七草の節句', '七草粥を食べて無病息災を願う'),
            ],
            (1, 11): [
                ('鏡開き', '正月の鏡餅を割っていただく'),
            ],
        }
        
        key = (self.month, self.day)
        events = events_db.get(key, [])
        
        if not events:
            return f'{self.month}月{self.day}日そのものは広く知られた国民の祝日ではありませんが、季節の節目として大切にされてきた日です。'
        
        result = f'{self.month}月{self.day}日の記念日・行事：\n\n'
        for name, desc in events:
            result += f'■ {name}\n{desc}\n\n'
        
        return result
    
    def get_mythology_and_legends(self):
        """神話・伝説"""
        myths = {
            12: '師走といえば「神々の帰還」。出雲での神議りを終えた八百万の神が、それぞれの地に戻ってくる月とされています。また冬至の頃は「一陽来復」といい、陰の極まりから陽気が復活し始める転換点として、古来より重視されてきました。',
            1: '睦月は新年の月。古来より「年神様」が各家庭を訪れ、新しい年の幸福をもたらすと信じられています。門松や鏡餅は年神様を迎えるためのものです。',
            10: '神無月といえば「神々の会議」。出雲に集う八百万の神は、夫婦の縁、人と人の巡り合わせ、土地の平安などを話し合うと信じられています。',
            11: '霜月は「神々の帰還準備」の月。出雲での神議りが終わり、各地の神々が戻る準備を始める時期とされます。'
        }
        return myths.get(self.month, myths.get(12, ''))
    
    def get_cultural_trivia(self):
        """文化雑学"""
        trivia = {
            12: f'旧暦{AccurateLunarCalendar.calculate_lunar_date(self.date)["month"]}月は別名「師走（しわす）」。師（僧侶）も走り回るほど忙しい月という説や、「年が果てる（しはす）」が転じたという説があります。一年の締めくくりとして、様々な行事や準備に追われる様子を表しています。',
            1: '旧暦1月は別名「睦月（むつき）」。新年を迎えて親族が睦み合う月という意味です。正月の様々な行事は、もともと旧暦1月に行われていたものです。',
            10: '旧暦10月は別名「神去月（かみさりつき）」とも呼ばれました。これは神々が出雲へ向かい、地元を留守にするという信仰から来たもの。ただし、出雲地方では反対に「神在月」と呼ばれ、神を迎えるための祭りが盛大に行われます。暦は地域の文化を色濃く反映していたのですね。'
        }
        return trivia.get(self.month, trivia.get(12, ''))
    
    def get_weather_info(self):
        """気象情報"""
        weather = {
            12: [
                '朝晩の冷え込みが増し、最低気温が0℃前後まで下がる地域も',
                '乾燥が進み、風が強い日は落ち葉が舞う',
                '山では初雪の便りが届き、スキー場がオープン',
                '夜空は快晴が多く、星が非常に見やすい季節'
            ],
            1: [
                '一年で最も寒い時期、厳しい寒さが続く',
                '太平洋側は乾燥した晴天が多い',
                '日本海側は雪や曇りの日が多い',
                '空気が澄んで遠くの山々がくっきり見える'
            ]
        }
        return weather.get(self.month, weather[12])
    
    def get_seasonal_foods(self):
        """旬の食材（12ヶ月完全版）"""
        foods = {
            1: {'vegetables': ['白菜', 'ネギ', '小松菜', '大根', 'ほうれん草', '春菊', 'かぶ', 'れんこん'], 'fruits': ['みかん', '金柑', 'いちご', 'りんご'], 'seafood': ['鱈', '寒ブリ', '牡蠣', 'あんこう', 'ふぐ', 'はまぐり'], 'special': '寒さで甘みが増した野菜が美味しい時期。鍋料理や煮物が一層美味しくなります。', 'ceremonial': '七草粥（芹、薺、御形、繁縷、仏の座、菘、蘿蔔）で正月疲れの胃腸を休めます。'},
            2: {'vegetables': ['白菜', 'ネギ', 'ブロッコリー', 'カリフラワー', 'ほうれん草', 'からし菜'], 'fruits': ['いちご', 'キウイ', 'はっさく'], 'seafood': ['鰆', 'わかめ', '牡蠣', 'あんこう'], 'special': 'まだ寒さが続き、冬野菜が美味しい時期。春の走りの食材も出始めます。', 'ceremonial': '節分には恵方巻や豆を食べる習慣があります。'},
            3: {'vegetables': ['菜の花', '春キャベツ', '新玉ねぎ', 'アスパラガス', 'ふきのとう', 'たけのこ'], 'fruits': ['いちご', 'デコポン', 'はっさく'], 'seafood': ['桜鯛', 'ホタルイカ', 'あさり', 'しらす'], 'special': '春の息吹を感じる山菜や新野菜が出回り始めます。', 'ceremonial': 'ひな祭りには菱餅、ひなあられ、ちらし寿司を楽しみます。'},
            4: {'vegetables': ['筍', '新じゃがいも', '春キャベツ', 'そら豆', '新玉ねぎ', 'アスパラガス'], 'fruits': ['いちご', 'グレープフルーツ', 'デコポン'], 'seafood': ['初鰹', '桜えび', 'あさり', 'さより'], 'special': '新野菜が豊富に出回り、春の味覚を存分に楽しめる時期。', 'ceremonial': '花見では花見団子や桜餅を楽しみます。'},
            5: {'vegetables': ['新玉ねぎ', 'そら豆', 'グリーンピース', '新生姜', 'たけのこ'], 'fruits': ['さくらんぼ', 'メロン', 'びわ'], 'seafood': ['初鰹', 'アジ', 'イサキ', 'ホタルイカ'], 'special': '新緑の季節にふさわしい、瑞々しい野菜が美味しい時期。', 'ceremonial': '端午の節句には柏餅やちまきを食べます。'},
            6: {'vegetables': ['梅', 'らっきょう', '新生姜', 'ズッキーニ', 'きゅうり', 'トマト'], 'fruits': ['さくらんぼ', 'びわ', 'メロン', 'あんず'], 'seafood': ['アジ', 'イワシ', '穴子', 'あゆ'], 'special': '梅雨の時期ですが、梅仕事や夏野菜の準備で楽しい時期。', 'ceremonial': '梅干しや梅酒などの梅仕事が盛んに行われます。'},
            7: {'vegetables': ['トマト', 'きゅうり', 'なす', 'ピーマン', 'とうもろこし', 'オクラ'], 'fruits': ['桃', 'スイカ', 'メロン', 'プラム'], 'seafood': ['鰻', 'アジ', '穴子', 'ハモ', 'いわし'], 'special': '夏野菜が本格的に出回り、夏バテ防止に効果的な食材が豊富。', 'ceremonial': '土用の丑の日には鰻を食べて夏バテを防ぎます。'},
            8: {'vegetables': ['トマト', 'きゅうり', 'なす', 'オクラ', 'ゴーヤ', 'ピーマン'], 'fruits': ['桃', 'スイカ', 'ぶどう', 'プラム'], 'seafood': ['鰹', 'アジ', '太刀魚', 'いわし'], 'special': '真夏の暑さに負けないよう、栄養豊富な夏野菜をたっぷりと。', 'ceremonial': 'お盆にはそうめんや精進料理をいただきます。'},
            9: {'vegetables': ['さつまいも', '里芋', '栗', '松茸', 'しめじ', 'まいたけ'], 'fruits': ['ぶどう', '梨', '柿', 'いちじく'], 'seafood': ['秋刀魚', '鰹', '鮭', 'さば'], 'special': '実りの秋。きのこ類や根菜類が美味しくなる季節。', 'ceremonial': '十五夜には月見団子や里芋を供えます。'},
            10: {'vegetables': ['さつまいも', '里芋', '栗', '松茸', 'しいたけ', 'かぼちゃ'], 'fruits': ['柿', 'りんご', 'ぶどう', '梨'], 'seafood': ['秋刀魚', '鮭', '鯖', '牡蠣'], 'special': '秋の味覚が最盛期。実りの季節を存分に楽しめます。', 'ceremonial': '新米の季節。新嘗祭に向けて収穫を祝います。'},
            11: {'vegetables': ['大根', '白菜', '春菊', 'ほうれん草', 'かぶ', '長ねぎ', '里芋'], 'fruits': ['柿', 'みかん', 'りんご', 'ゆず'], 'seafood': ['ブリ', '鯖', '牡蠣', 'ふぐ'], 'special': '特に「大根」はこの時期に甘くなり、ふろふき大根やおでんに最適。', 'ceremonial': '新嘗祭の名残で「新米」、秋の収穫を祝う「芋煮」「けんちん汁」などが親しまれます。'},
            12: {'vegetables': ['大根', '白菜', '春菊', 'ほうれん草', 'かぶ', '長ねぎ', '里芋', 'ゆず'], 'fruits': ['みかん', 'りんご', '柚子', '金柑'], 'seafood': ['ブリ', 'カキ（牡蠣）', 'サバ', '鱈', 'ふぐ', 'あんこう'], 'special': '特に「大根」はこの時期に甘くなり、ふろふき大根やおでんに最適。また、寒さが増すと「鍋料理」が家庭の主役になります。', 'ceremonial': '冬至には南瓜（かぼちゃ）を食べる習慣があり、年越しそばで一年を締めくくります。'}
        }
        return foods.get(self.month, foods[12])
    
    def get_flowers_and_plants(self):
        """季節の花と植物（12ヶ月完全版）"""
        flowers = {
            1: {'main': ('福寿草', 'ふくじゅそう', '幸せを招く・永久の幸福', '新春を告げる黄金の花。雪解けとともに咲き始める春の使者です。'), 'others': [('梅', 'うめ', '高潔・忍耐・美', '早春に咲く香り高い花'), ('水仙', 'すいせん', '自己愛・神秘', '清楚な香りの冬の花'), ('ロウバイ', 'ろうばい', '慈愛・先見', '蝋のような質感の黄色い花')]},
            2: {'main': ('梅', 'うめ', '高潔・忍耐・美', '早春に咲く香り高い花。まだ寒い中、春の訪れを告げます。'), 'others': [('福寿草', 'ふくじゅそう', '幸せを招く', '新春を告げる黄金の花'), ('スノードロップ', 'すのーどろっぷ', '希望・慰め', '雪の中でも咲く小さな白い花'), ('クロッカス', 'くろっかす', '青春の喜び', '早春を彩る花')]},
            3: {'main': ('桜', 'さくら', '精神の美・優美な女性', '日本の春を代表する花。満開の桜は日本人の心を魅了し続けます。'), 'others': [('菜の花', 'なのはな', '快活・明るさ', '春の野を黄色く染める'), ('チューリップ', 'ちゅーりっぷ', '思いやり', '春の花壇を彩る'), ('木蓮', 'もくれん', '自然への愛', '春の青空に映える白や紫の花')]},
            4: {'main': ('藤', 'ふじ', '歓迎・優しさ', '紫の花房が美しく垂れ下がる。藤棚の下は幻想的な空間です。'), 'others': [('八重桜', 'やえざくら', '豊かな教養', '豪華な八重咲きの桜'), ('牡丹', 'ぼたん', '富貴・高貴', '百花の王と呼ばれる豪華な花'), ('つつじ', 'つつじ', '節度・慎み', '春の庭を彩る')]},
            5: {'main': ('牡丹', 'ぼたん', '富貴・高貴', '百花の王と呼ばれる豪華な花。大きく華やかな花が初夏を彩ります。'), 'others': [('藤', 'ふじ', '歓迎・優しさ', '紫の花房が美しい'), ('菖蒲', 'あやめ', '希望・メッセージ', '端午の節句の花'), ('薔薇', 'ばら', '愛・美', '初夏の庭の女王')]},
            6: {'main': ('紫陽花', 'あじさい', '移り気・辛抱強い愛', '梅雨を彩る色変わりの花。雨に濡れた姿が美しい。'), 'others': [('花菖蒲', 'はなしょうぶ', '優しい心', '梅雨時に咲く紫の花'), ('百合', 'ゆり', '純潔・威厳', '清楚で香り高い'), ('クチナシ', 'くちなし', '喜びを運ぶ', '甘い香りの白い花')]},
            7: {'main': ('朝顔', 'あさがお', 'はかない恋・愛情の絆', '夏の朝を飾る涼しげな花。日本の夏の風物詩です。'), 'others': [('向日葵', 'ひまわり', 'あなただけを見つめる', '太陽に向かって咲く'), ('百日紅', 'さるすべり', '雄弁', '夏を通して咲き続ける'), ('蓮', 'はす', '清らかな心', '泥中から美しく咲く')]},
            8: {'main': ('向日葵', 'ひまわり', '憧れ・あなただけを見つめる', '太陽に向かって咲く夏の花。元気と明るさの象徴です。'), 'others': [('朝顔', 'あさがお', 'はかない恋', '夏の朝を飾る'), ('百日紅', 'さるすべり', '雄弁', '長く咲き続ける'), ('ハイビスカス', 'はいびすかす', '新しい恋', '南国の雰囲気')]},
            9: {'main': ('彼岸花', 'ひがんばな', '再会・情熱', '秋の彼岸に咲く真紅の花。別名曼珠沙華とも呼ばれます。'), 'others': [('コスモス', 'こすもす', '調和・謙虚', '秋風に揺れる可憐な花'), ('桔梗', 'ききょう', '誠実・変わらぬ愛', '秋の七草のひとつ'), ('女郎花', 'おみなえし', '美人・親切', '秋の七草のひとつ')]},
            10: {'main': ('コスモス', 'こすもす', '調和・謙虚', '秋風に揺れる可憐な花。秋桜とも書き、秋の代表花です。'), 'others': [('菊', 'きく', '高貴・高潔', '秋を代表する花'), ('金木犀', 'きんもくせい', '謙虚・気高い人', '甘い香りが漂う'), ('リンドウ', 'りんどう', '誠実', '秋の野に咲く')]},
            11: {'main': ('山茶花', 'さざんか', '困難に打ち勝つ・ひたむきさ', '霜に負けずに咲く冬の花。冬の訪れを告げる庭木としても親しまれています。'), 'others': [('菊', 'きく', '高貴・高潔', '秋を代表する花'), ('千両', 'せんりょう', '商売繁盛・裕福', '正月飾りの縁起物'), ('南天', 'なんてん', '難を転ずる', '厄除けの縁起木')]},
            12: {'main': ('水仙', 'すいせん', '自己愛・神秘', '清楚な香りの冬の花。霜に負けずに凛と咲く姿が冬の庭を彩ります。'), 'others': [('山茶花', 'さざんか', '困難に打ち勝つ・ひたむきさ', '冬の訪れを告げる庭木'), ('千両', 'せんりょう', '商売繁盛・裕福', '正月飾りの縁起物'), ('南天', 'なんてん', '難を転ずる', '厄除けの縁起木')]}
        }
        return flowers.get(self.month, flowers[12])
    
    def get_astronomy_info(self, lunar):
        """天文情報"""
        moon_age = lunar['age']
        
        info = {
            'moon': f"月齢{moon_age}の今日は{lunar['appearance']}。{lunar['phase']}の時期は、月の陰影の変化が美しく観察できます。",
            'stars': []
        }
        
        if self.month in [12, 1, 2]:
            info['stars'] = [
                '冬の星座オリオンが東から昇り始める',
                '冬の大三角（ベテルギウス・シリウス・プロキオン）が見頃',
                'おうし座のプレアデス星団（すばる）が美しい',
                '空気が乾いているため天の川がくっきり見える日も'
            ]
        
        return info
    
    def get_traditional_crafts(self):
        """伝統工芸"""
        crafts = {
            12: [
                ('藁細工', 'わらざいく', 'しめ縄、わらぐつ、縄飾りなど', '冬の農閑期の代表的な手仕事'),
                ('干し柿づくり', 'ほしがきづくり', '吊るし柿', '地域によっては街を彩る冬の風物詩'),
                ('正月飾り', 'しょうがつかざり', '門松、しめ飾り', '新年を迎える準備の工芸'),
                ('曲げわっぱ', 'まげわっぱ', '秋田の伝統工芸', '新米の季節に合わせて弁当箱の需要も増える')
            ],
            1: [
                ('凧', 'たこ', 'お正月の遊び道具', '伝統的な和凧は芸術作品'),
                ('羽子板', 'はごいた', '女の子の正月遊び', '厄除けの意味も'),
                ('書き初め', 'かきぞめ', '新年の習字', '一年の抱負を書く'),
                ('餅つき', 'もちつき', '杵と臼での伝統作業', '正月の準備')
            ]
        }
        return crafts.get(self.month, crafts[12])
    
    def get_festivals_and_rituals(self):
        """祭事と神話伝説"""
        festivals = {
            12: '師走は一年の締めくくりの月。大祓（おおはらえ）で一年の穢れを払い、除夜の鐘で煩悩を消し去ります。また、冬至は「一陽来復」として陰が極まり陽に転じる重要な転換点とされ、各地で冬至祭が行われます。',
            1: '正月は一年で最も重要な祭事。年神様を迎え入れる準備として、門松や鏡餅を飾ります。元日の初詣では一年の無事を祈願し、七草粥で無病息災を願います。小正月（1月15日）には小豆粥を食べ、どんど焼きで正月飾りを焚き上げます。',
            11: '出雲地方では11月は「神在祭」の真っ最中。神楽が奉納され、稲佐の浜で神迎えの儀式が行われます。これは古事記や日本書紀に記される「国譲り神話」とも深く関係し、大国主命が国を天照大神の系譜へと譲った後、出雲が重要な神事の中心となったとされることが背景です。'
        }
        return festivals.get(self.month, festivals.get(12, ''))
    
    def get_traditional_arts(self):
        """伝統芸能"""
        arts = {
            12: '12月は能楽・歌舞伎の公演が活発。特に「冬支度」や「大雪」に合わせた曲目として、能「小鍛冶」、歌舞伎「仮名手本忠臣蔵」（冬の名作）が演じられることが多い時期です。',
            1: '新春を祝う能楽・歌舞伎の公演が各地で開催。特に「翁」（能）、「寿曽我対面」（歌舞伎）など、めでたい演目が正月にふさわしいとされます。',
            11: '11月は能楽・歌舞伎の公演が活発。特に「冬支度」や「小雪」に合わせた曲目として、能「小鍛冶」、歌舞伎「仮名手本忠臣蔵」（冬の名作）が演じられることが多い時期です。'
        }
        return arts.get(self.month, arts.get(12, ''))
    
    def generate_full_html(self):
        """完全版HTML生成"""
        lunar = AccurateLunarCalendar.calculate_lunar_date(self.date)
        sekki = SolarTermCalculator.get_sekki_info(self.date)
        kou = SolarTermCalculator.get_kou_info(self.date)
        
        weekdays = ["月", "火", "水", "木", "金", "土", "日"]
        weekday = weekdays[self.date.weekday()]
        
        lunar_names = self.get_lunar_month_names()
        lunar_info = lunar_names.get(lunar['month'], ("", "", ""))
        
        seasonal_desc = self.generate_seasonal_description(lunar, sekki, kou)
        nature_changes = self.get_nature_changes()
        agri = self.get_agricultural_calendar()
        customs = self.get_customs_and_traditions()
        holidays = self.get_holidays_and_events()
        mythology = self.get_mythology_and_legends()
        trivia = self.get_cultural_trivia()
        weather = self.get_weather_info()
        foods = self.get_seasonal_foods()
        flowers = self.get_flowers_and_plants()
        astro = self.get_astronomy_info(lunar)
        crafts = self.get_traditional_crafts()
        festivals = self.get_festivals_and_rituals()
        arts = self.get_traditional_arts()
        
        # Gemini APIで各セクションの文章を強化
        print("  Gemini APIで文章を生成中...")
        nature_text = self.gemini.enhance_nature_changes(self.month, nature_changes) or "、".join(nature_changes)
        agri_text = self.gemini.enhance_agricultural_info(self.month, agri) or agri['detail']
        food_text = self.gemini.enhance_food_description(self.month, foods) or foods['special']
        flower_text = self.gemini.enhance_flower_description(self.month, flowers['main']) or flowers['main'][3]
        astro_text = self.gemini.enhance_astronomical_info(lunar, self.month) or astro['moon']
        
        html = f"""
<div style="font-family: 'ヒラギノ角ゴ Pro', 'Hiragino Kaku Gothic Pro', 'メイリオ', Meiryo, sans-serif; max-width: 900px; margin: 0 auto; line-height: 1.9; color: #2d3748;">

<h2 style="color: #2c5282; border-bottom: 4px solid #4299e1; padding-bottom: 12px; margin-bottom: 25px; font-size: 28px;">今日の暦情報</h2>

<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);">
<p style="margin: 0; font-size: 24px; font-weight: bold;">西暦: {self.date.year}年{self.date.month}月{self.date.day}日（{weekday}曜日）</p>
<p style="margin: 15px 0 0 0; font-size: 20px;">旧暦: {lunar['month']}月{lunar['day']}日（{lunar_info[0]}）</p>
<p style="margin: 10px 0 0 0; font-size: 20px;">月齢: {lunar['age']}（{lunar['phase']}）</p>
<p style="margin: 10px 0 0 0; font-size: 17px; opacity: 0.95; line-height: 1.7;">{lunar['appearance']}</p>
</div>

<div style="background: #f7fafc; padding: 25px; border-radius: 12px; border-left: 5px solid #4299e1; margin-bottom: 35px;">
<p style="margin: 0; line-height: 2; font-size: 16px;">{seasonal_desc}</p>
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<h3 style="color: #2d3748; font-size: 26px; margin-bottom: 25px; border-left: 6px solid #fc8181; padding-left: 15px;">季節の移ろい</h3>

<div style="background: linear-gradient(to right, #fff5f5, transparent); border-left: 6px solid #fc8181; padding: 25px; margin-bottom: 25px; border-radius: 8px;">
<h4 style="color: #c53030; margin: 0 0 12px 0; font-size: 22px;">二十四節気: {sekki[0]}（{sekki[1]}）</h4>
<p style="margin: 0; color: #2d3748; line-height: 2; font-size: 16px;">{sekki[2]}</p>
</div>

<div style="background: linear-gradient(to right, #f0fff4, transparent); border-left: 6px solid #48bb78; padding: 25px; margin-bottom: 30px; border-radius: 8px;">
<h4 style="color: #2f855a; margin: 0 0 12px 0; font-size: 22px;">七十二候: {kou[0]}</h4>
<p style="margin: 8px 0; color: #2d3748; font-size: 15px;"><em>読み:</em> {kou[1]}</p>
<p style="margin: 12px 0 0 0; color: #2d3748; line-height: 2; font-size: 16px;">{kou[2]}</p>
</div>

<div style="background: #fffaf0; padding: 25px; border-radius: 10px; margin-bottom: 30px; border: 2px solid #fbd38d;">
<h4 style="color: #c05621; margin: 0 0 15px 0; font-size: 20px;">自然の変化としては:</h4>
<p style="margin: 0; color: #2d3748; line-height: 2; font-size: 15px;">{nature_text}</p>
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<h3 style="color: #2d3748; font-size: 26px; margin-bottom: 25px; border-left: 6px solid #68d391; padding-left: 15px;">農事歴（農業暦）</h3>

<div style="background: linear-gradient(135deg, #fef5e7, #fef3c7); padding: 28px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
<p style="margin: 0 0 18px 0; font-size: 20px; font-weight: bold; color: #744210;">この時期は「{agri['title']}」</p>
<p style="margin: 0; color: #744210; line-height: 2; font-size: 15px;">{agri_text}</p>
<div style="margin: 20px 0 0 0; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 8px;">
<p style="margin: 0 0 10px 0; font-weight: bold; color: #92400e;">主な作業:</p>
<ul style="margin: 0; padding-left: 25px; color: #744210; line-height: 1.8;">
{"".join(f"<li style='margin-bottom: 8px; font-size: 14px;'>{activity}</li>" for activity in agri['activities'])}
</ul>
</div>
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<h3 style="color: #2d3748; font-size: 26px; margin-bottom: 25px; border-left: 6px solid #9f7aea; padding-left: 15px;">日本の風習・しきたり</h3>

<div style="background: #faf5ff; padding: 28px; border-radius: 12px; border-left: 6px solid #9f7aea; margin-bottom: 30px;">
<p style="margin: 0 0 20px 0; line-height: 2; color: #2d3748; font-size: 16px;">{customs['description']}</p>
<h4 style="color: #6b46c1; margin: 20px 0 15px 0; font-size: 19px;">この時期の風習:</h4>
<ul style="margin: 0; padding-left: 30px; color: #2d3748; line-height: 2;">
{"".join(f"<li style='margin-bottom: 10px; font-size: 15px;'>{item}</li>" for item in customs['items'])}
</ul>
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<h3 style="color: #2d3748; font-size: 26px; margin-bottom: 25px; border-left: 6px solid #f6ad55; padding-left: 15px;">日本の記念日と祝日</h3>

<div style="background: linear-gradient(135deg, #fffaf0, #fef3c7); padding: 28px; border-radius: 12px; margin-bottom: 30px;">
<div style="color: #744210; line-height: 2; font-size: 16px; white-space: pre-line;">{holidays}</div>
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<h3 style="color: #2d3748; font-size: 26px; margin-bottom: 25px; border-left: 6px solid #ed64a6; padding-left: 15px;">日本の神話・伝説</h3>

<div style="background: linear-gradient(135deg, #fef5f8, #fce7f3); padding: 28px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #f9a8d4;">
<p style="margin: 0; color: #831843; line-height: 2; font-size: 16px;">{mythology}</p>
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<h3 style="color: #2d3748; font-size: 26px; margin-bottom: 25px; border-left: 6px solid #4299e1; padding-left: 15px;">暦にまつわる文化雑学</h3>

<div style="background: #ebf8ff; padding: 28px; border-radius: 12px; margin-bottom: 30px; border-left: 5px solid #4299e1;">
<p style="margin: 0; color: #1e40af; line-height: 2; font-size: 16px;">{trivia}</p>
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<h3 style="color: #2d3748; font-size: 26px; margin-bottom: 25px; border-left: 6px solid #38b2ac; padding-left: 15px;">自然と気象情報</h3>

<div style="background: linear-gradient(135deg, #e6fffa, #b2f5ea); padding: 28px; border-radius: 12px; margin-bottom: 30px;">
<ul style="margin: 0; padding-left: 30px; color: #234e52; line-height: 2;">
{"".join(f"<li style='margin-bottom: 12px; font-size: 16px;'>{w}</li>" for w in weather)}
</ul>
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<h3 style="color: #2d3748; font-size: 26px; margin-bottom: 25px; border-left: 6px solid #f56565; padding-left: 15px;">旬の食材・行事食</h3>

<div style="background: linear-gradient(135deg, #fff5f5, #fed7d7); padding: 28px; border-radius: 12px; margin-bottom: 30px;">
<h4 style="color: #c53030; margin: 0 0 15px 0; font-size: 20px;">旬を迎える食材:</h4>
<p style="margin: 0 0 20px 0; color: #742a2a; line-height: 2; font-size: 15px;">{food_text}</p>
<div style="padding: 18px; background: rgba(255,255,255,0.6); border-radius: 8px; margin-bottom: 15px;">
<p style="margin: 0 0 8px 0; font-size: 15px; color: #742a2a; line-height: 1.8;">
<strong>野菜:</strong> {", ".join(foods['vegetables'])}
</p>
<p style="margin: 8px 0; font-size: 15px; color: #742a2a; line-height: 1.8;">
<strong>果物:</strong> {", ".join(foods['fruits'])}
</p>
<p style="margin: 8px 0; font-size: 15px; color: #742a2a; line-height: 1.8;">
<strong>魚介:</strong> {", ".join(foods['seafood'])}
</p>
</div>
<p style="margin: 15px 0 0 0; padding: 18px; background: rgba(255,255,255,0.6); border-radius: 8px; color: #742a2a; line-height: 2; font-size: 15px;"><strong>行事食としては:</strong><br>{foods['ceremonial']}</p>
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<h3 style="color: #2d3748; font-size: 26px; margin-bottom: 25px; border-left: 6px solid #f687b3; padding-left: 15px;">季節の草木と花言葉</h3>

<div style="background: linear-gradient(135deg, #fff0f5, #ffe4f3); padding: 28px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
<p style="margin: 0 0 8px 0; font-size: 22px; font-weight: bold; color: #831843;">季節の花: {flowers['main'][0]}（{flowers['main'][1]}）</p>
<p style="margin: 12px 0; color: #9f1239; font-size: 17px;"><em>花言葉:</em> 「{flowers['main'][2]}」</p>
<p style="margin: 12px 0 0 0; color: #be185d; line-height: 2; font-size: 15px;">{flower_text}</p>
</div>

<div style="background: #fef5f8; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
<h4 style="color: #9f1239; margin: 0 0 15px 0; font-size: 19px;">その他の植物:</h4>
{"".join(f"<div style='margin-bottom: 18px; padding: 15px; background: white; border-radius: 8px;'><p style='margin: 0; font-size: 17px; font-weight: bold; color: #831843;'>{name}（{reading}）</p><p style='margin: 8px 0 0 0; color: #be185d; font-size: 15px;'>花言葉: 「{meaning}」<br>{desc}</p></div>" for name, reading, meaning, desc in flowers['others'])}
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<h3 style="color: #2d3748; font-size: 26px; margin-bottom: 25px; border-left: 6px solid #4299e1; padding-left: 15px;">月や星の暦・天文情報</h3>

<div style="background: linear-gradient(135deg, #ebf4ff, #dbeafe); padding: 28px; border-radius: 12px; margin-bottom: 30px;">
<p style="margin: 0 0 20px 0; line-height: 2; color: #1e40af; font-size: 15px;">{astro_text}</p>
<h4 style="color: #1e3a8a; margin: 20px 0 15px 0; font-size: 19px;">星空では:</h4>
<ul style="margin: 0; padding-left: 30px; color: #1e40af; line-height: 2;">
{"".join(f"<li style='margin-bottom: 12px; font-size: 15px;'>{star}</li>" for star in astro['stars'])}
</ul>
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<h3 style="color: #2d3748; font-size: 26px; margin-bottom: 25px; border-left: 6px solid #ed8936; padding-left: 15px;">伝統工芸・民芸品</h3>

<div style="background: linear-gradient(135deg, #fffaf0, #feebc8); padding: 28px; border-radius: 12px; margin-bottom: 30px;">
<p style="margin: 0 0 20px 0; color: #7c2d12; font-size: 16px; line-height: 2;">この季節に関連して作られるものとしては:</p>
{"".join(f"<div style='margin-bottom: 20px; padding: 18px; background: white; border-radius: 8px; border-left: 4px solid #ed8936;'><p style='margin: 0 0 8px 0; font-size: 18px; font-weight: bold; color: #c05621;'>{name}（{reading}）</p><p style='margin: 0; color: #7c2d12; font-size: 15px;'><strong>{item}:</strong> {desc}</p></div>" for name, reading, item, desc in crafts)}
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<h3 style="color: #2d3748; font-size: 26px; margin-bottom: 25px; border-left: 6px solid #805ad5; padding-left: 15px;">祭事の背景・神話伝説</h3>

<div style="background: linear-gradient(135deg, #faf5ff, #e9d8fd); padding: 28px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #b794f4;">
<p style="margin: 0; color: #44337a; line-height: 2; font-size: 16px;">{festivals}</p>
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<h3 style="color: #2d3748; font-size: 26px; margin-bottom: 25px; border-left: 6px solid #d53f8c; padding-left: 15px;">伝統芸能</h3>

<div style="background: linear-gradient(135deg, #fff5f7, #fed7e2); padding: 28px; border-radius: 12px; margin-bottom: 35px;">
<p style="margin: 0; color: #702459; line-height: 2; font-size: 16px;">{arts}</p>
</div>

<hr style="border: none; border-top: 3px solid #e2e8f0; margin: 40px 0;">

<div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.08);">
<p style="margin: 0; font-size: 18px; color: #14532d; font-weight: 500; line-height: 2;">
季節を感じながら、今日も良い一日をお過ごしください
</p>
</div>

</div>
"""
        
        return {
            'title': f'{self.date.year}年{self.date.month}月{self.date.day}日({weekday})の暦情報',
            'content': html,
            'labels': ['暦', '二十四節気', '旧暦', '季節', '七十二候', '農事歴', '風習', '伝統文化', '行事食', '天文', '神話', '伝統芸能']
        }


class BloggerPoster:
    """Blogger投稿クラス"""
    
    def __init__(self):
        self.credentials = None
        self.service = None
        
    def authenticate(self):
        """Google APIの認証"""
        creds = None
        
        if os.environ.get('GOOGLE_TOKEN'):
            token_data = json.loads(os.environ['GOOGLE_TOKEN'])
            creds = Credentials.from_authorized_user_info(token_data, SCOPES)
        
        if not creds or not creds.valid:
            if creds and creds.expired and creds.refresh_token:
                creds.refresh(Request())
            else:
                if os.environ.get('GOOGLE_CREDENTIALS'):
                    creds_data = json.loads(os.environ['GOOGLE_CREDENTIALS'])
                    flow = InstalledAppFlow.from_client_config(creds_data, SCOPES)
                    creds = flow.run_local_server(port=0)
                else:
                    raise Exception("認証情報が見つかりません")
        
        self.credentials = creds
        self.service = build('blogger', 'v3', credentials=creds)
        
    def post_to_blog(self, blog_id, title, content, labels):
        """Bloggerに投稿"""
        try:
            post = {
                'kind': 'blogger#post',
                'title': title,
                'content': content,
                'labels': labels
            }
            
            request = self.service.posts().insert(blogId=blog_id, body=post)
            response = request.execute()
            
            print(f"投稿成功: {response.get('url')}")
            return response
            
        except Exception as e:
            print(f"投稿エラー: {str(e)}")
            raise


def main():
    """メイン処理"""
    try:
        blog_id = os.environ.get('BLOG_ID')
        if not blog_id:
            raise Exception("BLOG_ID環境変数が設定されていません")
        
        print("=" * 70)
        print("暦情報自動投稿システム 完全版 起動")
        print("=" * 70)
        print(f"投稿日時: {datetime.now(ZoneInfo('Asia/Tokyo')).strftime('%Y年%m月%d日 %H:%M:%S')}")
        
        # 暦情報生成
        print("\n今日の暦情報を生成中...")
        print("- 全セクション実装版")
        print("- 見本と同等の情報量")
        
        generator = ComprehensiveCalendarGenerator()
        post_data = generator.generate_full_html()
        
        print(f"\nタイトル: {post_data['title']}")
        print(f"セクション数: 14セクション")
        print(f"推定文字数: 約{len(post_data['content'])}文字")
        
        # Blogger投稿
        print("\nBloggerに投稿中...")
        poster = BloggerPoster()
        poster.authenticate()
        poster.post_to_blog(blog_id, post_data['title'], post_data['content'], post_data['labels'])
        
        print("\n" + "=" * 70)
        print("すべての処理が完了しました！")
        print("見本と同等の豊富な暦情報が投稿されました")
        print("=" * 70)
        
    except Exception as e:
        print(f"\nエラーが発生しました: {str(e)}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == '__main__':
    main()
