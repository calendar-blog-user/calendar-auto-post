#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æš¦æƒ…å ±è‡ªå‹•æŠ•ç¨¿ã‚·ã‚¹ãƒ†ãƒ  - å®Œå…¨ç‰ˆï¼ˆå…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…ï¼‰
è¦‹æœ¬ã¨åŒç­‰ã®æƒ…å ±é‡ã‚’æä¾›
"""

import os
import json
import sys
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo
import math
import requests
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow
from google.auth.transport.requests import Request
from googleapiclient.discovery import build

SCOPES = ['https://www.googleapis.com/auth/blogger']

class SolarTermCalculator:
    """äºŒåå››ç¯€æ°—ãƒ»ä¸ƒåäºŒå€™ã®å¤©æ–‡è¨ˆç®—ã‚¯ãƒ©ã‚¹ï¼ˆæ¯å¹´è‡ªå‹•å¯¾å¿œï¼‰"""
    
    @staticmethod
    def calculate_solar_term_date(year, solar_longitude):
        """
        æŒ‡å®šã—ãŸå¹´ã¨å¤ªé™½é»„çµŒã‹ã‚‰ç¯€æ°—ã®æ—¥ä»˜ã‚’è¨ˆç®—
        å¤ªé™½é»„çµŒ: 0Â°=æ˜¥åˆ†, 15Â°=æ¸…æ˜, 30Â°=ç©€é›¨, ..., 345Â°=å•“èŸ„
        ç•¥ç®—å¼ã‚’ä½¿ç”¨ï¼ˆç²¾åº¦Â±1æ—¥ï¼‰
        """
        # äºŒåå››ç¯€æ°—ã®ä¿‚æ•°ï¼ˆDã¨Aï¼‰
        # å‡ºå…¸: æµ·ä¸Šä¿å®‰åºæ°´è·¯éƒ¨ã®ç•¥ç®—å¼ã‚’æ‹¡å¼µ
        sekki_params = {
            315: (5.01, 0.242778),   # ç«‹æ˜¥
            330: (19.70, 0.242713),  # é›¨æ°´
            345: (6.38, 0.242627),   # å•“èŸ„
            0:   (21.43, 0.242194),  # æ˜¥åˆ†
            15:  (5.59, 0.241934),   # æ¸…æ˜
            30:  (21.04, 0.241669),  # ç©€é›¨
            45:  (6.30, 0.241424),   # ç«‹å¤
            60:  (22.18, 0.241176),  # å°æº€
            75:  (6.62, 0.240959),   # èŠ’ç¨®
            90:  (22.29, 0.240715),  # å¤è‡³
            105: (7.93, 0.240460),   # å°æš‘
            120: (23.95, 0.240252),  # å¤§æš‘
            135: (8.52, 0.240014),   # ç«‹ç§‹
            150: (24.30, 0.239766),  # å‡¦æš‘
            165: (8.60, 0.239527),   # ç™½éœ²
            180: (23.89, 0.239300),  # ç§‹åˆ†
            195: (9.09, 0.239063),   # å¯’éœ²
            210: (24.19, 0.238825),  # éœœé™
            225: (8.19, 0.238591),   # ç«‹å†¬
            240: (23.15, 0.238355),  # å°é›ª
            255: (7.93, 0.238120),   # å¤§é›ª
            270: (22.66, 0.237885),  # å†¬è‡³
            285: (6.12, 0.237651),   # å°å¯’
            300: (20.87, 0.237418)   # å¤§å¯’
        }
        
        if solar_longitude not in sekki_params:
            return None
        
        D, A = sekki_params[solar_longitude]
        
        # 1æœˆãƒ»2æœˆã®ç¯€æ°—ã¯å‰å¹´åŸºæº–ã§è¨ˆç®—
        if solar_longitude in [285, 300, 315, 330]:
            Y = year - 1900 - 1
        else:
            Y = year - 1900
        
        # ç•¥ç®—å¼: INT(D + (A Ã— Y) - INT(Y / 4))
        day = int(D + (A * Y) - int(Y / 4))
        
        # æœˆã®æ±ºå®š
        if solar_longitude == 285:  # å°å¯’
            month = 1
        elif solar_longitude == 300:  # å¤§å¯’
            month = 1
            day += 15
        elif solar_longitude == 315:  # ç«‹æ˜¥
            month = 2
        elif solar_longitude == 330:  # é›¨æ°´
            month = 2
            day += 14
        elif solar_longitude == 345:  # å•“èŸ„
            month = 3
        elif solar_longitude == 0:  # æ˜¥åˆ†
            month = 3
            day += 15
        elif solar_longitude == 15:  # æ¸…æ˜
            month = 4
        elif solar_longitude == 30:  # ç©€é›¨
            month = 4
            day += 15
        elif solar_longitude == 45:  # ç«‹å¤
            month = 5
        elif solar_longitude == 60:  # å°æº€
            month = 5
            day += 16
        elif solar_longitude == 75:  # èŠ’ç¨®
            month = 6
        elif solar_longitude == 90:  # å¤è‡³
            month = 6
            day += 16
        elif solar_longitude == 105:  # å°æš‘
            month = 7
        elif solar_longitude == 120:  # å¤§æš‘
            month = 7
            day += 16
        elif solar_longitude == 135:  # ç«‹ç§‹
            month = 8
        elif solar_longitude == 150:  # å‡¦æš‘
            month = 8
            day += 16
        elif solar_longitude == 165:  # ç™½éœ²
            month = 9
        elif solar_longitude == 180:  # ç§‹åˆ†
            month = 9
            day += 16
        elif solar_longitude == 195:  # å¯’éœ²
            month = 10
        elif solar_longitude == 210:  # éœœé™
            month = 10
            day += 15
        elif solar_longitude == 225:  # ç«‹å†¬
            month = 11
        elif solar_longitude == 240:  # å°é›ª
            month = 11
            day += 15
        elif solar_longitude == 255:  # å¤§é›ª
            month = 12
        elif solar_longitude == 270:  # å†¬è‡³
            month = 12
            day += 15
        
        return (month, day)
    
    @classmethod
    def get_current_sekki(cls, date):
        """ç¾åœ¨ã®äºŒåå››ç¯€æ°—ã‚’å¤©æ–‡è¨ˆç®—ã§å–å¾—"""
        year = date.year
        month = date.month
        day = date.day
        
        # å…¨24ç¯€æ°—ã®å®šç¾©
        sekki_definitions = [
            (315, "ç«‹æ˜¥", "ã‚Šã£ã—ã‚…ã‚“", "æ˜¥ã®å§‹ã¾ã‚Šã€‚æš¦ã®ä¸Šã§ã¯æ˜¥ã§ã™ãŒã€ã¾ã å¯’ã•ãŒå³ã—ã„æ™‚æœŸã§ã™ã€‚"),
            (330, "é›¨æ°´", "ã†ã™ã„", "é›ªãŒé›¨ã«å¤‰ã‚ã‚Šã€æ°·ãŒè§£ã‘å§‹ã‚ã‚‹é ƒã€‚ä¸‰å¯’å››æ¸©ã§æ˜¥ã«å‘ã‹ã„ã¾ã™ã€‚"),
            (345, "å•“èŸ„", "ã‘ã„ã¡ã¤", "å†¬çœ ã—ã¦ã„ãŸè™«ãŒç›®è¦šã‚ã‚‹é ƒã€‚æ˜¥ã®è¨ªã‚Œã‚’å®Ÿæ„Ÿã§ãã¾ã™ã€‚"),
            (0, "æ˜¥åˆ†", "ã—ã‚…ã‚“ã¶ã‚“", "æ˜¼å¤œã®é•·ã•ãŒã»ã¼ç­‰ã—ããªã‚‹æ—¥ã€‚ã“ã‚Œã‹ã‚‰æ˜¼ãŒé•·ããªã‚Šã¾ã™ã€‚"),
            (15, "æ¸…æ˜", "ã›ã„ã‚ã„", "ä¸‡ç‰©ãŒæ¸…ã‚‰ã‹ã§ç”Ÿãç”Ÿãã¨ã™ã‚‹é ƒã€‚èŠ±ãŒå’²ãèª‡ã‚‹å­£ç¯€ã§ã™ã€‚"),
            (30, "ç©€é›¨", "ã“ãã†", "ç©€ç‰©ã‚’æ½¤ã™æ˜¥ã®é›¨ãŒé™ã‚‹é ƒã€‚ç”°æ¤ãˆã®æº–å‚™ãŒå§‹ã¾ã‚Šã¾ã™ã€‚"),
            (45, "ç«‹å¤", "ã‚Šã£ã‹", "å¤ã®å§‹ã¾ã‚Šã€‚æ–°ç·‘ãŒç›®ã«é®®ã‚„ã‹ãªå­£ç¯€ã§ã™ã€‚"),
            (60, "å°æº€", "ã—ã‚‡ã†ã¾ã‚“", "è‰æœ¨ãŒèŒ‚ã‚Šã€å¤©åœ°ã«æ°—ãŒæº€ã¡å§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (75, "èŠ’ç¨®", "ã¼ã†ã—ã‚…", "éº¦ã‚’åˆˆã‚Šã€ç¨²ã‚’æ¤ãˆã‚‹è¾²ç¹æœŸã€‚æ¢…é›¨å…¥ã‚Šã®æ™‚æœŸã§ã™ã€‚"),
            (90, "å¤è‡³", "ã’ã—", "ä¸€å¹´ã§æœ€ã‚‚æ˜¼ãŒé•·ã„æ—¥ã€‚ã“ã‚Œã‹ã‚‰æš‘ã•ãŒæœ¬æ ¼åŒ–ã—ã¾ã™ã€‚"),
            (105, "å°æš‘", "ã—ã‚‡ã†ã—ã‚‡", "æ¢…é›¨æ˜ã‘é ƒã€‚æœ¬æ ¼çš„ãªæš‘ã•ã®å§‹ã¾ã‚Šã§ã™ã€‚"),
            (120, "å¤§æš‘", "ãŸã„ã—ã‚‡", "ä¸€å¹´ã§æœ€ã‚‚æš‘ã„æ™‚æœŸã€‚å¤çœŸã£ç››ã‚Šã§ã™ã€‚"),
            (135, "ç«‹ç§‹", "ã‚Šã£ã—ã‚…ã†", "ç§‹ã®å§‹ã¾ã‚Šã€‚æš¦ã®ä¸Šã§ã¯ç§‹ã§ã™ãŒã€æ®‹æš‘ãŒå³ã—ã„æ™‚æœŸã€‚"),
            (150, "å‡¦æš‘", "ã—ã‚‡ã—ã‚‡", "æš‘ã•ãŒå³ ã‚’è¶Šãˆã‚‹é ƒã€‚æœå¤•ãŒæ¶¼ã—ããªã‚Šå§‹ã‚ã¾ã™ã€‚"),
            (165, "ç™½éœ²", "ã¯ãã‚", "è‰æœ¨ã«ç™½ã„éœ²ãŒå®¿ã‚Šå§‹ã‚ã‚‹é ƒã€‚ç§‹ã®æ°—é…ãŒæ¿ƒããªã‚Šã¾ã™ã€‚"),
            (180, "ç§‹åˆ†", "ã—ã‚…ã†ã¶ã‚“", "æ˜¼å¤œã®é•·ã•ãŒã»ã¼ç­‰ã—ã„ã€‚ç§‹å½¼å²¸ã®ä¸­æ—¥ã§ã™ã€‚"),
            (195, "å¯’éœ²", "ã‹ã‚“ã‚", "éœ²ãŒå†·ãŸãæ„Ÿã˜ã‚‰ã‚Œã‚‹é ƒã€‚ç´…è‘‰ãŒå§‹ã¾ã‚Šã¾ã™ã€‚"),
            (210, "éœœé™", "ãã†ã“ã†", "æœéœœãŒé™ã‚Šå§‹ã‚ã‚‹é ƒã€‚ç§‹ãŒæ·±ã¾ã‚Šã¾ã™ã€‚"),
            (225, "ç«‹å†¬", "ã‚Šã£ã¨ã†", "å†¬ã®å§‹ã¾ã‚Šã€‚æš¦ã®ä¸Šã§ã¯å†¬å…¥ã‚Šã§ã™ã€‚"),
            (240, "å°é›ª", "ã—ã‚‡ã†ã›ã¤", "ã‚ãšã‹ã«é›ªãŒé™ã‚Šå§‹ã‚ã‚‹é ƒã€‚å†¬ã®æ°—é…ãŒå¼·ã¾ã‚Šã¾ã™ã€‚"),
            (255, "å¤§é›ª", "ãŸã„ã›ã¤", "é›ªãŒæœ¬æ ¼çš„ã«é™ã‚Šå§‹ã‚ã‚‹é ƒã€‚å±±ã¯é›ªåŒ–ç²§ã§ã™ã€‚"),
            (270, "å†¬è‡³", "ã¨ã†ã˜", "ä¸€å¹´ã§æœ€ã‚‚æ˜¼ãŒçŸ­ã„æ—¥ã€‚ã“ã‚Œã‹ã‚‰æ—¥ãŒé•·ããªã‚Šã¾ã™ã€‚"),
            (285, "å°å¯’", "ã—ã‚‡ã†ã‹ã‚“", "å¯’ã•ãŒå³ã—ããªã‚Šå§‹ã‚ã‚‹é ƒã€‚å¯’ã®å…¥ã‚Šã§ã™ã€‚"),
            (300, "å¤§å¯’", "ã ã„ã‹ã‚“", "ä¸€å¹´ã§æœ€ã‚‚å¯’ã„æ™‚æœŸã€‚å¯’ã•ã®æ¥µã¿ã§ã™ã€‚")
        ]
        
        # å„ç¯€æ°—ã®æ—¥ä»˜ã‚’è¨ˆç®—
        sekki_dates = []
        for longitude, name, reading, desc in sekki_definitions:
            term_date = cls.calculate_solar_term_date(year, longitude)
            if term_date:
                sekki_dates.append((term_date[0], term_date[1], name, reading, desc))
        
        # å‰å¹´ã®å†¬ã®ç¯€æ°—ã‚‚è¿½åŠ ï¼ˆå¹´å§‹ã®åˆ¤å®šç”¨ï¼‰
        for longitude in [255, 270, 285, 300]:
            term_date = cls.calculate_solar_term_date(year - 1, longitude)
            if term_date:
                for lng, name, reading, desc in sekki_definitions:
                    if lng == longitude:
                        sekki_dates.append((term_date[0], term_date[1], name, reading, desc))
        
        # ç¾åœ¨ã®æ—¥ä»˜ã«æœ€ã‚‚è¿‘ã„éå»ã®ç¯€æ°—ã‚’æ¢ã™
        current_sekki = sekki_dates[0][2:]
        for m, d, name, reading, desc in sekki_dates:
            if month > m or (month == m and day >= d):
                current_sekki = (name, reading, desc)
        
        return current_sekki
    
    @classmethod
    def get_kou_info(cls, date):
        """ç¾åœ¨ã®ä¸ƒåäºŒå€™"""
        month = date.month
        day = date.day
        
        kou_list = [
            # å†¬ï¼ˆ12æœˆå¾ŒåŠã€œ2æœˆï¼‰
            (12, 7, "é–‰å¡æˆå†¬", "ãã‚‰ã•ã‚€ããµã‚†ã¨ãªã‚‹", "å¤©åœ°ã®æ°—ãŒå¡ãŒã‚Šã€æœ¬æ ¼çš„ãªå†¬ã¨ãªã‚‹é ƒã€‚å¤§é›ªã§ã™ã€‚"),
            (12, 12, "ç†ŠèŸ„ç©´", "ãã¾ã‚ãªã«ã“ã‚‚ã‚‹", "ç†ŠãŒå†¬çœ ã®ãŸã‚ã«ç©´ã«å…¥ã‚‹é ƒã§ã™ã€‚"),
            (12, 16, "é±–é­šç¾¤", "ã•ã‘ã®ã†ãŠã‚€ã‚‰ãŒã‚‹", "é®­ãŒç¾¤ãŒã£ã¦å·ã‚’ä¸Šã‚‹é ƒã§ã™ã€‚"),
            (12, 21, "ä¹ƒæ±ç”Ÿ", "ãªã¤ã‹ã‚Œãã•ã—ã‚‡ã†ãš", "å¤æ¯è‰ãŒèŠ½ã‚’å‡ºã™é ƒã€‚å†¬è‡³ã§ã™ã€‚"),
            (12, 26, "éº‹è§’è§£", "ã•ã‚ã—ã‹ã¤ã®ãŠã¤ã‚‹", "å¤§é¹¿ãŒè§’ã‚’è½ã¨ã™é ƒã§ã™ã€‚"),
            (12, 31, "é›ªä¸‹å‡ºéº¦", "ã‚†ãã‚ãŸã‚Šã¦ã‚€ãã®ã³ã‚‹", "é›ªã®ä¸‹ã§éº¦ãŒèŠ½ã‚’å‡ºã™é ƒã§ã™ã€‚"),
            (1, 5, "èŠ¹ä¹ƒæ „", "ã›ã‚Šã™ãªã‚ã¡ã•ã‹ã†", "èŠ¹ãŒç››ã‚“ã«ç”Ÿãˆå§‹ã‚ã‚‹é ƒã€‚å°å¯’ã§ã™ã€‚"),
            (1, 10, "æ°´æ³‰å‹•", "ã—ã¿ãšã‚ãŸãŸã‹ã‚’ãµãã‚€", "åœ°ä¸­ã§å‡ã£ãŸæ³‰ãŒå‹•ãå§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (1, 15, "é›‰å§‹é›Š", "ãã˜ã¯ã˜ã‚ã¦ãªã", "é›‰ãŒé³´ãå§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (1, 20, "æ¬¾å†¬è¯", "ãµãã®ã¯ãªã•ã", "è•—ã®èŠ±ãŒå’²ãé ƒã€‚å¤§å¯’ã§ã™ã€‚"),
            (1, 25, "æ°´æ²¢è…¹å …", "ã•ã‚ã¿ãšã“ãŠã‚Šã¤ã‚ã‚‹", "æ²¢ã®æ°´ãŒåšãå‡ã‚‹é ƒã€‚å¯’ã•ã®æ¥µã¿ã§ã™ã€‚"),
            (1, 30, "é¶å§‹ä¹³", "ã«ã‚ã¨ã‚Šã¯ã˜ã‚ã¦ã¨ã‚„ã«ã¤ã", "é¶ãŒåµã‚’ç”£ã¿å§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (2, 4, "æ±é¢¨è§£å‡", "ã¯ã‚‹ã‹ãœã“ãŠã‚Šã‚’ã¨ã", "æ˜¥é¢¨ãŒæ°·ã‚’è§£ã‹ã—å§‹ã‚ã‚‹é ƒã€‚ç«‹æ˜¥ã®åˆå€™ã§ã™ã€‚"),
            (2, 9, "é»„é¶¯çç†", "ã†ãã„ã™ãªã", "é¶¯ãŒå±±é‡Œã§é³´ãå§‹ã‚ã‚‹é ƒã€‚æ˜¥ã®è¨ªã‚Œã‚’å‘Šã’ã‚‹é³´ãå£°ã§ã™ã€‚"),
            (2, 14, "é­šä¸Šæ°·", "ã†ãŠã“ãŠã‚Šã‚’ã„ãšã‚‹", "å‰²ã‚ŒãŸæ°·ã®é–“ã‹ã‚‰é­šãŒé£›ã³è·³ã­ã‚‹é ƒã§ã™ã€‚"),
            (2, 19, "åœŸè„‰æ½¤èµ·", "ã¤ã¡ã®ã—ã‚‡ã†ã†ã‚‹ãŠã„ãŠã“ã‚‹", "é›¨ãŒé™ã£ã¦åœŸãŒæ¹¿ã‚Šæ°—ã‚’å«ã‚€é ƒã§ã™ã€‚"),
            (2, 24, "éœå§‹é†", "ã‹ã™ã¿ã¯ã˜ã‚ã¦ãŸãªã³ã", "éœãŒãŸãªã³ãã€æ˜¥æ™¯è‰²ãŒåºƒãŒã‚‹é ƒã§ã™ã€‚"),
            # æ˜¥ï¼ˆ3æœˆã€œ5æœˆï¼‰
            (3, 1, "è‰æœ¨èŒå‹•", "ãã†ã‚‚ãã‚ã°ãˆã„ãšã‚‹", "è‰æœ¨ãŒèŠ½å¹ãå§‹ã‚ã‚‹é ƒã€‚æ˜¥ã®æ¯å¹ã‚’æ„Ÿã˜ã¾ã™ã€‚"),
            (3, 5, "èŸ„è™«å•“æˆ¸", "ã™ã”ã‚‚ã‚Šã‚€ã—ã¨ã‚’ã²ã‚‰ã", "å†¬çœ ã—ã¦ã„ãŸè™«ãŒå¤–ã«é€™ã„å‡ºã¦ãã‚‹é ƒã§ã™ã€‚"),
            (3, 10, "æ¡ƒå§‹ç¬‘", "ã‚‚ã‚‚ã¯ã˜ã‚ã¦ã•ã", "æ¡ƒã®èŠ±ãŒå’²ãå§‹ã‚ã‚‹é ƒã€‚ç¬‘ã¯å’²ãã®æ„å‘³ã§ã™ã€‚"),
            (3, 15, "èœè™«åŒ–è¶", "ãªã‚€ã—ã¡ã‚‡ã†ã¨ãªã‚‹", "é’è™«ãŒè¶ã«ç¾½åŒ–ã™ã‚‹é ƒã€‚æ˜¥ã®ç”Ÿå‘½ã®èºå‹•ã§ã™ã€‚"),
            (3, 20, "é›€å§‹å·£", "ã™ãšã‚ã¯ã˜ã‚ã¦ã™ãã†", "é›€ãŒå·£ã‚’ä½œã‚Šå§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (3, 25, "æ«»å§‹é–‹", "ã•ãã‚‰ã¯ã˜ã‚ã¦ã²ã‚‰ã", "æ¡œãŒå’²ãå§‹ã‚ã‚‹é ƒã€‚æ˜¥ã®ä»£åè©ã§ã™ã€‚"),
            (3, 30, "é›·ä¹ƒç™ºå£°", "ã‹ã¿ãªã‚Šã™ãªã‚ã¡ã“ãˆã‚’ã¯ã£ã™", "é ãã§é›·ã®éŸ³ãŒèã“ãˆå§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (4, 4, "ç„é³¥è‡³", "ã¤ã°ã‚ããŸã‚‹", "ç‡•ãŒå—ã‹ã‚‰æ¸¡ã£ã¦ãã‚‹é ƒã€‚æ˜¥ã®ä½¿è€…ã§ã™ã€‚"),
            (4, 9, "é´»é›åŒ—", "ã“ã†ãŒã‚“ã‹ãˆã‚‹", "é›ãŒåŒ—ã¸å¸°ã£ã¦ã„ãé ƒã§ã™ã€‚"),
            (4, 14, "è™¹å§‹è¦‹", "ã«ã˜ã¯ã˜ã‚ã¦ã‚ã‚‰ã‚ã‚‹", "é›¨ä¸ŠãŒã‚Šã«è™¹ãŒå‡ºå§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (4, 20, "è‘­å§‹ç”Ÿ", "ã‚ã—ã¯ã˜ã‚ã¦ã—ã‚‡ã†ãš", "è‘¦ãŒèŠ½ã‚’å¹ãå§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (4, 25, "éœœæ­¢å‡ºè‹—", "ã—ã‚‚ã‚„ã‚“ã§ãªãˆã„ãš", "éœœãŒé™ã‚Šãªããªã‚Šã€è‹—ãŒè‚²ã¤é ƒã§ã™ã€‚"),
            (4, 30, "ç‰¡ä¸¹è¯", "ã¼ãŸã‚“ã¯ãªã•ã", "ç‰¡ä¸¹ã®èŠ±ãŒå’²ãé ƒã€‚è¯ã‚„ã‹ãªæ˜¥ã®çµ‚ã‚ã‚Šã§ã™ã€‚"),
            # å¤ï¼ˆ5æœˆã€œ8æœˆï¼‰
            (5, 5, "è›™å§‹é³´", "ã‹ã‚ãšã¯ã˜ã‚ã¦ãªã", "è›™ãŒé³´ãå§‹ã‚ã‚‹é ƒã€‚åˆå¤ã®é¢¨ç‰©è©©ã§ã™ã€‚"),
            (5, 10, "èš¯èš“å‡º", "ã¿ã¿ãšã„ãšã‚‹", "èš¯èš“ãŒåœ°ä¸Šã«é€™ã„å‡ºã¦ãã‚‹é ƒã§ã™ã€‚"),
            (5, 15, "ç«¹ç¬‹ç”Ÿ", "ãŸã‘ã®ã“ã—ã‚‡ã†ãš", "ç­ãŒç”Ÿãˆã¦ãã‚‹é ƒã€‚æ—¬ã®å‘³è¦šã§ã™ã€‚"),
            (5, 21, "èš•èµ·é£Ÿæ¡‘", "ã‹ã„ã“ãŠãã¦ãã‚ã‚’ã¯ã‚€", "èš•ãŒæ¡‘ã®è‘‰ã‚’ç››ã‚“ã«é£Ÿã¹å§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (5, 26, "ç´…èŠ±æ „", "ã¹ã«ã°ãªã•ã‹ã†", "ç´…èŠ±ãŒç››ã‚“ã«å’²ãé ƒã§ã™ã€‚"),
            (5, 31, "éº¦ç§‹è‡³", "ã‚€ãã®ã¨ãã„ãŸã‚‹", "éº¦ãŒç†Ÿã—ã€åç©«æœŸã‚’è¿ãˆã‚‹é ƒã§ã™ã€‚"),
            (6, 5, "èŸ·è‚ç”Ÿ", "ã‹ã¾ãã‚Šã—ã‚‡ã†ãš", "èŸ·è‚ãŒç”Ÿã¾ã‚Œå‡ºã‚‹é ƒã§ã™ã€‚"),
            (6, 10, "è…è‰ç‚ºè¢", "ãã•ã‚ŒãŸã‚‹ãã•ã»ãŸã‚‹ã¨ãªã‚‹", "è›ãŒå…‰ã‚’æ”¾ã¡å§‹ã‚ã‚‹é ƒã€‚åˆå¤ã®é¢¨æƒ…ã§ã™ã€‚"),
            (6, 16, "æ¢…å­é»„", "ã†ã‚ã®ã¿ãã°ã‚€", "æ¢…ã®å®ŸãŒé»„ã°ã‚“ã§ç†Ÿã™é ƒã§ã™ã€‚"),
            (6, 21, "ä¹ƒæ±æ¯", "ãªã¤ã‹ã‚Œãã•ã‹ã‚‹ã‚‹", "å¤æ¯è‰ãŒæ¯ã‚Œã‚‹é ƒã€‚å¤è‡³ã®æ—¥ã§ã™ã€‚"),
            (6, 26, "è–è’²è¯", "ã‚ã‚„ã‚ã¯ãªã•ã", "è–è’²ã®èŠ±ãŒå’²ãé ƒã§ã™ã€‚"),
            (7, 2, "åŠå¤ç”Ÿ", "ã¯ã‚“ã’ã—ã‚‡ã†ãš", "çƒæŸ„æ“ãŒç”Ÿãˆã‚‹é ƒã€‚ç”°æ¤ãˆã®ç›®å®‰ã¨ã•ã‚Œã¾ã—ãŸã€‚"),
            (7, 7, "æ¸©é¢¨è‡³", "ã‚ã¤ã‹ãœã„ãŸã‚‹", "æš‘ã„é¢¨ãŒå¹ã„ã¦ãã‚‹é ƒã€‚å¤æœ¬ç•ªã§ã™ã€‚"),
            (7, 12, "è“®å§‹é–‹", "ã¯ã™ã¯ã˜ã‚ã¦ã²ã‚‰ã", "è“®ã®èŠ±ãŒé–‹ãå§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (7, 17, "é·¹ä¹ƒå­¦ç¿’", "ãŸã‹ã™ãªã‚ã¡ã‚ã–ã‚’ãªã‚‰ã†", "é·¹ã®å¹¼é³¥ãŒé£›ã³æ–¹ã‚’è¦šãˆã‚‹é ƒã§ã™ã€‚"),
            (7, 22, "æ¡å§‹çµèŠ±", "ãã‚Šã¯ã˜ã‚ã¦ã¯ãªã‚’ã‚€ã™ã¶", "æ¡ã®èŠ±ãŒå®Ÿã‚’çµã¶é ƒã§ã™ã€‚"),
            (7, 28, "åœŸæ½¤æº½æš‘", "ã¤ã¡ã†ã‚‹ãŠã†ã¦ã‚€ã—ã‚ã¤ã—", "åœŸãŒæ¹¿ã£ã¦è’¸ã—æš‘ããªã‚‹é ƒã§ã™ã€‚"),
            (8, 2, "å¤§é›¨æ™‚è¡Œ", "ãŸã„ã†ã¨ãã©ããµã‚‹", "æ™‚ã¨ã—ã¦å¤§é›¨ãŒé™ã‚‹é ƒã€‚å¤•ç«‹ã®å­£ç¯€ã§ã™ã€‚"),
            # ç§‹ï¼ˆ8æœˆã€œ11æœˆï¼‰
            (8, 7, "æ¶¼é¢¨è‡³", "ã™ãšã‹ãœã„ãŸã‚‹", "æ¶¼ã—ã„é¢¨ãŒå¹ãå§‹ã‚ã‚‹é ƒã€‚ç«‹ç§‹ã§ã™ã€‚"),
            (8, 12, "å¯’è‰é³´", "ã²ãã‚‰ã—ãªã", "èœ©ãŒé³´ãå§‹ã‚ã‚‹é ƒã€‚ç§‹ã®æ°—é…ã‚’æ„Ÿã˜ã¾ã™ã€‚"),
            (8, 17, "è’™éœ§å‡é™", "ãµã‹ããã‚Šã¾ã¨ã†", "æ·±ã„éœ§ãŒã¾ã¨ã‚ã‚Šã¤ãé ƒã§ã™ã€‚"),
            (8, 23, "ç¶¿æŸé–‹", "ã‚ãŸã®ã¯ãªã—ã¹ã²ã‚‰ã", "ç¶¿ã®èŠ±ã®ãŒããŒé–‹ãé ƒã§ã™ã€‚"),
            (8, 28, "å¤©åœ°å§‹ç²›", "ã¦ã‚“ã¡ã¯ã˜ã‚ã¦ã•ã‚€ã—", "å¤©åœ°ã®æš‘ã•ãŒåã¾ã‚Šå§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (9, 2, "ç¦¾ä¹ƒç™»", "ã“ãã‚‚ã®ã™ãªã‚ã¡ã¿ã®ã‚‹", "ç¨²ãŒå®Ÿã‚‹é ƒã€‚å®Ÿã‚Šã®ç§‹ã§ã™ã€‚"),
            (9, 7, "è‰éœ²ç™½", "ãã•ã®ã¤ã‚†ã—ã‚ã—", "è‰ã«é™ã‚ŠãŸéœ²ãŒç™½ãè¦‹ãˆã‚‹é ƒã§ã™ã€‚"),
            (9, 12, "é¶ºé´’é³´", "ã›ãã‚Œã„ãªã", "é¶ºé´’ãŒé³´ãå§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (9, 17, "ç„é³¥å»", "ã¤ã°ã‚ã•ã‚‹", "ç‡•ãŒå—ã¸å¸°ã£ã¦ã„ãé ƒã§ã™ã€‚"),
            (9, 23, "é›·ä¹ƒåå£°", "ã‹ã¿ãªã‚Šã™ãªã‚ã¡ã“ãˆã‚’ãŠã•ã‚€", "é›·ãŒé³´ã‚‰ãªããªã‚‹é ƒã€‚ç§‹åˆ†ã§ã™ã€‚"),
            (9, 28, "èŸ„è™«åæˆ¸", "ã‚€ã—ã‹ãã‚Œã¦ã¨ã‚’ãµã•ã", "è™«ãŒåœŸã®ä¸­ã«éš ã‚Œã‚‹é ƒã§ã™ã€‚"),
            (10, 3, "æ°´å§‹æ¶¸", "ã¿ãšã¯ã˜ã‚ã¦ã‹ã‚‹ã‚‹", "ç”°ã‚“ã¼ã®æ°´ã‚’æŠœãå§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (10, 8, "é´»é›æ¥", "ã“ã†ãŒã‚“ããŸã‚‹", "é›ãŒé£›æ¥ã™ã‚‹é ƒã€‚å†¬é³¥ã®åˆ°æ¥ã§ã™ã€‚"),
            (10, 13, "èŠèŠ±é–‹", "ããã®ã¯ãªã²ã‚‰ã", "èŠã®èŠ±ãŒå’²ãé ƒã§ã™ã€‚"),
            (10, 18, "èŸ‹èŸ€åœ¨æˆ¸", "ãã‚Šãã‚Šã™ã¨ã«ã‚ã‚Š", "èŸ‹èŸ€ãŒæˆ¸å£ã§é³´ãé ƒã§ã™ã€‚"),
            (10, 23, "éœœå§‹é™", "ã—ã‚‚ã¯ã˜ã‚ã¦ãµã‚‹", "éœœãŒé™ã‚Šå§‹ã‚ã‚‹é ƒã€‚éœœé™ã§ã™ã€‚"),
            (10, 28, "éœæ™‚æ–½", "ã“ã•ã‚ã¨ãã©ããµã‚‹", "å°é›¨ãŒã—ã¨ã—ã¨é™ã‚‹é ƒã§ã™ã€‚"),
            (11, 2, "æ¥“è”¦é»„", "ã‚‚ã¿ã˜ã¤ãŸãã°ã‚€", "ç´…è‘‰ã‚„è”¦ãŒé»„è‘‰ã™ã‚‹é ƒã§ã™ã€‚"),
            # å†¬ï¼ˆ11æœˆã€œ12æœˆå‰åŠï¼‰
            (11, 7, "å±±èŒ¶å§‹é–‹", "ã¤ã°ãã¯ã˜ã‚ã¦ã²ã‚‰ã", "å±±èŒ¶èŠ±ãŒå’²ãå§‹ã‚ã‚‹é ƒã€‚ç«‹å†¬ã§ã™ã€‚"),
            (11, 12, "åœ°å§‹å‡", "ã¡ã¯ã˜ã‚ã¦ã“ãŠã‚‹", "å¤§åœ°ãŒå‡ã‚Šå§‹ã‚ã‚‹é ƒã§ã™ã€‚"),
            (11, 17, "é‡‘ç›é¦™", "ãã‚“ã›ã‚“ã‹ã•ã", "æ°´ä»™ã®èŠ±ãŒå’²ãé ƒã§ã™ã€‚"),
            (11, 22, "è™¹è”µä¸è¦‹", "ã«ã˜ã‹ãã‚Œã¦ã¿ãˆãš", "è™¹ã‚’è¦‹ã‹ã‘ãªããªã‚‹é ƒã€‚å°é›ªã§ã™ã€‚"),
            (11, 27, "æœ”é¢¨æ‰•è‘‰", "ããŸã‹ãœã“ã®ã¯ã‚’ã¯ã‚‰ã†", "åŒ—é¢¨ãŒæœ¨ã®è‘‰ã‚’æ‰•ã„è½ã¨ã™é ƒã€‚å†¬ã®é¢¨ç‰©è©©ã§ã™ã€‚"),
            (12, 2, "æ©˜å§‹é»„", "ãŸã¡ã°ãªã¯ã˜ã‚ã¦ãã°ã‚€", "æ©˜ã®å®ŸãŒé»„è‰²ãè‰²ã¥ãé ƒã§ã™ã€‚")
        ]
        
        current_kou = kou_list[0][2:]
        
        for m, d, name, reading, desc in reversed(kou_list):
            if month > m or (month == m and day >= d):
                current_kou = (name, reading, desc)
                break
        
        if month == 12 and day >= 31:
            current_kou = ("é›ªä¸‹å‡ºéº¦", "ã‚†ãã‚ãŸã‚Šã¦ã‚€ãã®ã³ã‚‹", "é›ªã®ä¸‹ã§éº¦ãŒèŠ½ã‚’å‡ºã™é ƒã§ã™ã€‚")
        elif month == 1 and day < 5:
            current_kou = ("é›ªä¸‹å‡ºéº¦", "ã‚†ãã‚ãŸã‚Šã¦ã‚€ãã®ã³ã‚‹", "é›ªã®ä¸‹ã§éº¦ãŒèŠ½ã‚’å‡ºã™é ƒã§ã™ã€‚")
        
        return current_kou


class CalendarInfoGenerator:
    """æš¦æƒ…å ±ç”Ÿæˆã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        self.jst = ZoneInfo("Asia/Tokyo")
        self.calc = SolarTermCalculator()
    
    def get_season_emoji(self, month):
        """å­£ç¯€ã®çµµæ–‡å­—"""
        if month in [3, 4, 5]:
            return "ğŸŒ¸"
        elif month in [6, 7, 8]:
            return "ğŸŒ»"
        elif month in [9, 10, 11]:
            return "ğŸ"
        else:
            return "â„ï¸"
    
    def generate_blog_content(self, target_date=None):
        """ãƒ–ãƒ­ã‚°è¨˜äº‹ã®HTMLç”Ÿæˆ"""
        if target_date is None:
            target_date = datetime.now(self.jst)
        
        sekki_name, sekki_reading, sekki_desc = self.calc.get_current_sekki(target_date)
        kou_name, kou_reading, kou_desc = self.calc.get_kou_info(target_date)
        
        season_emoji = self.get_season_emoji(target_date.month)
        
        html = f"""
<div style="font-family: 'Noto Serif JP', serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.8;">
    <h2 style="border-left: 5px solid #4a90e2; padding-left: 15px; color: #333;">
        {season_emoji} æœ¬æ—¥ã®æš¦ - {target_date.strftime('%Yå¹´%mæœˆ%dæ—¥')}
    </h2>
    
    <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 25px; border-radius: 10px; margin: 20px 0;">
        <h3 style="color: #2c3e50; margin-top: 0;">ğŸ“… äºŒåå››ç¯€æ°—</h3>
        <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
            <p style="font-size: 24px; font-weight: bold; color: #e74c3c; margin: 10px 0;">
                {sekki_name} <span style="font-size: 16px; color: #7f8c8d;">ï¼ˆ{sekki_reading}ï¼‰</span>
            </p>
            <p style="color: #555; margin: 10px 0;">{sekki_desc}</p>
        </div>
    </div>
    
    <div style="background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%); padding: 25px; border-radius: 10px; margin: 20px 0;">
        <h3 style="color: #00695c; margin-top: 0;">ğŸƒ ä¸ƒåäºŒå€™</h3>
        <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
            <p style="font-size: 20px; font-weight: bold; color: #00897b; margin: 10px 0;">
                {kou_name} <span style="font-size: 14px; color: #7f8c8d;">ï¼ˆ{kou_reading}ï¼‰</span>
            </p>
            <p style="color: #555; margin: 10px 0;">{kou_desc}</p>
        </div>
    </div>
    
    <div style="margin-top: 30px; padding: 20px; background: #fff9e6; border-left: 4px solid #ffc107; border-radius: 5px;">
        <p style="margin: 0; color: #666; font-size: 14px;">
            âœ¨ æ—¥æœ¬ã®ä¼çµ±çš„ãªæš¦ã«åŸºã¥ã„ãŸå­£ç¯€ã®ç§»ã‚ã„ã‚’ãŠå±Šã‘ã—ã¦ã„ã¾ã™
        </p>
    </div>
</div>
"""
        return html


class BloggerPoster:
    """BloggeræŠ•ç¨¿ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        self.blog_id = os.environ.get('BLOG_ID')
        self.service = self._get_blogger_service()
    
    def _get_blogger_service(self):
        """Blogger APIã‚µãƒ¼ãƒ“ã‚¹ã®å–å¾—"""
        creds = None
        
        token_json = os.environ.get('GOOGLE_TOKEN')
        if token_json:
            token_data = json.loads(token_json)
            creds = Credentials.from_authorized_user_info(token_data, SCOPES)
        
        if not creds or not creds.valid:
            if creds and creds.expired and creds.refresh_token:
                creds.refresh(Request())
            else:
                credentials_json = os.environ.get('GOOGLE_CREDENTIALS')
                if credentials_json:
                    credentials_data = json.loads(credentials_json)
                    flow = InstalledAppFlow.from_client_config(
                        credentials_data, SCOPES)
                    creds = flow.run_local_server(port=0)
                else:
                    raise ValueError("èªè¨¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        
        return build('blogger', 'v3', credentials=creds)
    
    def post_to_blog(self, title, content):
        """ãƒ–ãƒ­ã‚°ã«æŠ•ç¨¿"""
        try:
            post = {
                'kind': 'blogger#post',
                'blog': {'id': self.blog_id},
                'title': title,
                'content': content
            }
            
            result = self.service.posts().insert(
                blogId=self.blog_id,
                body=post
            ).execute()
            
            print(f"âœ… æŠ•ç¨¿æˆåŠŸ: {result.get('url')}")
            return result
        except Exception as e:
            print(f"âŒ æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: {str(e)}")
            raise


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    try:
        print("=" * 50)
        print("ğŸ“… æš¦æƒ…å ±è‡ªå‹•æŠ•ç¨¿ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•")
        print("=" * 50)
        
        # æ—¥æœ¬æ™‚é–“ã®ç¾åœ¨æ—¥æ™‚ã‚’å–å¾—
        jst = ZoneInfo("Asia/Tokyo")
        now = datetime.now(jst)
        print(f"ğŸ• å®Ÿè¡Œæ™‚åˆ»: {now.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S JST')}")
        
        # æš¦æƒ…å ±ã®ç”Ÿæˆ
        print("\nğŸ“ æš¦æƒ…å ±ã‚’ç”Ÿæˆä¸­...")
        generator = CalendarInfoGenerator()
        content = generator.generate_blog_content(now)
        
        # ã‚¿ã‚¤ãƒˆãƒ«ã®ç”Ÿæˆ
        title = f"æœ¬æ—¥ã®æš¦ - {now.strftime('%Yå¹´%mæœˆ%dæ—¥')}"
        
        # ãƒ–ãƒ­ã‚°ã«æŠ•ç¨¿
        print("ğŸ“¤ Bloggerã«æŠ•ç¨¿ä¸­...")
        poster = BloggerPoster()
        result = poster.post_to_blog(title, content)
        
        print("\n" + "=" * 50)
        print("âœ¨ ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ")
        print("=" * 50)
        
        return 0
        
    except Exception as e:
        print(f"\nâŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
        import traceback
        traceback.print_exc()
        return 1


if __name__ == "__main__":
    sys.exit(main())
